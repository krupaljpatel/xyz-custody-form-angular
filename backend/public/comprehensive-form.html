<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XYZ Custody Account Opening Form - Comprehensive v2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            /* Modern Color Palette */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            
            /* Base Colors */
            --primary: #667eea;
            --primary-light: rgba(102, 126, 234, 0.1);
            --primary-dark: #5a6fd8;
            --secondary: #6c757d;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            
            /* Neutral Colors */
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Typography */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', Monaco, Consolas, monospace;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            
            /* Transitions */
            --transition-fast: all 0.15s ease;
            --transition-normal: all 0.3s ease;
            --transition-slow: all 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-900);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            min-height: 100vh;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            min-height: 100vh;
        }

        .app-header {
            background: var(--white);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: var(--space-4) var(--space-8);
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .app-header nav {
            display: flex;
            gap: var(--space-2);
        }

        .nav-button {
            background: var(--white);
            color: var(--gray-700);
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: var(--transition-normal);
            z-index: -1;
        }

        .nav-button:hover::before,
        .nav-button.active::before {
            left: 0;
        }

        .nav-button:hover,
        .nav-button.active {
            color: var(--white);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .app-main {
            padding: var(--space-8);
            max-width: 1400px;
            margin: 0 auto;
        }

        .forms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: var(--space-6);
        }
        
        .forms-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .form-card {
            background: var(--white);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            transition: var(--transition-normal);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition-normal);
        }

        .form-card:hover {
            box-shadow: var(--shadow-2xl);
            transform: translateY(-4px);
            border-color: var(--primary-light);
        }

        .form-card:hover::before {
            opacity: 1;
        }

        .form-editor {
            background: var(--white);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
            margin: 0 auto;
            max-width: 1200px;
            border: 1px solid var(--gray-200);
            backdrop-filter: blur(20px);
        }

        .editor-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--space-8);
            text-align: center;
        }

        .editor-header h2 {
            margin: 0 0 var(--space-4) 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .form-tabs {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            overflow-x: auto;
            padding: 0 var(--space-4);
            gap: var(--space-2);
        }

        .tab-button {
            padding: var(--space-4) var(--space-6);
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-500);
            border-bottom: 2px solid transparent;
            transition: var(--transition-normal);
            white-space: nowrap;
            min-width: 150px;
            border-radius: var(--radius) var(--radius) 0 0;
            font-size: 0.875rem;
        }

        .tab-button:hover {
            background: var(--gray-100);
            color: var(--primary);
        }

        .tab-button.active {
            background: var(--white);
            color: var(--primary);
            border-bottom-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .tab-content {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .form-section {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .section-title {
            margin: 0 0 2rem 0;
            color: #007bff;
            font-size: 1.4rem;
            font-weight: 600;
            border-bottom: 3px solid #007bff;
            padding-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .section-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            background: var(--white);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
            position: relative;
        }

        .form-field::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-gradient);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            opacity: 0;
            transition: var(--transition-normal);
        }

        .form-field:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
            border-color: var(--primary-light);
        }

        .form-field:hover::before {
            opacity: 1;
        }

        .form-field label {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.875rem;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .form-field label::before {
            content: '•';
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: bold;
        }

        .form-field input[type="text"],
        .form-field input[type="email"],
        .form-field input[type="tel"],
        .form-field textarea,
        .form-field select {
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            transition: var(--transition-normal);
            background: var(--gray-50);
            font-family: var(--font-primary);
        }

        .form-field input:focus,
        .form-field textarea:focus,
        .form-field select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
            background: var(--white);
        }

        .form-field input::placeholder,
        .form-field textarea::placeholder {
            color: var(--gray-400);
            font-style: italic;
        }

        .form-field textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Enhanced checkbox and radio styling with better indentation */
        .field-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.75rem;
        }

        .radio-group,
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1.5rem;
            background: rgba(0,123,255,0.02);
            border-radius: 12px;
            border-left: 4px solid #007bff;
            position: relative;
        }

        .radio-group::before,
        .checkbox-group::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #007bff, #0056b3);
            border-radius: 0 2px 2px 0;
        }

        .radio-option,
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            margin-left: 1rem;
            position: relative;
            min-height: 55px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .radio-option::before,
        .checkbox-option::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 25px;
            background: rgba(0,123,255,0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .radio-option:hover,
        .checkbox-option:hover {
            border-color: #007bff;
            background: rgba(0,123,255,0.08);
            transform: translateX(8px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.15);
        }

        .radio-option:hover::before,
        .checkbox-option:hover::before {
            background: #007bff;
            width: 4px;
            height: 35px;
        }

        .radio-option input[type="radio"],
        .checkbox-option input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin: 0;
            accent-color: #007bff;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .radio-option input[type="radio"]:checked,
        .checkbox-option input[type="checkbox"]:checked {
            transform: scale(1.1);
        }

        .radio-option label,
        .checkbox-option label {
            cursor: pointer;
            margin: 0;
            font-weight: 500;
            flex: 1;
            font-size: 1rem;
            color: #495057;
            line-height: 1.5;
        }

        .radio-option input:checked + label,
        .checkbox-option input:checked + label {
            color: #007bff;
            font-weight: 600;
        }

        .multiselect-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
            max-height: 250px;
            overflow-y: auto;
            padding: 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: rgba(0,123,255,0.02);
            border-left: 4px solid #28a745;
            position: relative;
        }

        .multiselect-group::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #28a745, #1e7e34);
            border-radius: 0 2px 2px 0;
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            border: 1px solid #e9ecef;
            min-height: 45px;
            margin-left: 0.5rem;
            position: relative;
        }

        .multiselect-option::before {
            content: '';
            position: absolute;
            left: -0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 20px;
            background: rgba(40, 167, 69, 0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .multiselect-option:hover {
            background: rgba(40, 167, 69, 0.08);
            border-color: #28a745;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }

        .multiselect-option:hover::before {
            background: #28a745;
            width: 3px;
            height: 30px;
        }

        .multiselect-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #28a745;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .multiselect-option input[type="checkbox"]:checked {
            transform: scale(1.1);
        }

        .multiselect-option label {
            cursor: pointer;
            margin: 0;
            font-size: 0.95rem;
            font-weight: 500;
            color: #495057;
            flex: 1;
            line-height: 1.4;
        }

        .multiselect-option input:checked + label {
            color: #28a745;
            font-weight: 600;
        }

        .help-text {
            color: #6c757d;
            font-size: 0.9rem;
            font-style: italic;
            margin-top: 0.25rem;
            padding-left: 0.5rem;
            border-left: 3px solid #dee2e6;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            transition: var(--transition-normal);
        }

        .btn-primary:hover::before {
            left: 0;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            padding: var(--space-3) var(--space-6);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
            color: var(--primary);
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .conditional-field {
            transition: all 0.3s ease;
            grid-column: 1 / -1; /* Take full width of the grid */
            width: 100%;
            margin-left: 2rem; /* Indent to show it's conditional */
            border-left: 3px solid #e9ecef;
            padding-left: 1rem;
            background: rgba(0,123,255,0.02);
            border-radius: 8px;
        }

        .conditional-field.hidden {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .app-main {
                padding: 1rem;
            }
            
            .section-fields {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .form-tabs {
                padding: 0;
            }
            
            .tab-button {
                min-width: 120px;
                padding: 0.75rem 1rem;
            }
            
            .multiselect-group {
                grid-template-columns: 1fr;
            }
        }
        
        /* Guide Content Styles */
        .guide-content {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            border: 1px solid #c7d2fe;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            position: relative;
        }
        
        .guide-content h4 {
            color: var(--primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .guide-content h4:before {
            content: "📘";
            font-size: 1.25rem;
        }
        
        .guide-text {
            color: var(--gray-700);
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .guide-text p {
            margin-bottom: var(--space-3);
        }
        
        .guide-text p:last-child {
            margin-bottom: 0;
        }
        
        .guide-text strong {
            color: var(--gray-900);
            font-weight: 600;
        }
        
        .guide-text ul, .guide-text ol {
            margin: var(--space-3) 0;
            padding-left: var(--space-6);
        }
        
        .guide-text li {
            margin-bottom: var(--space-1);
        }
        
        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-trigger {
            cursor: help;
            margin-left: var(--space-1);
            color: var(--primary);
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: none;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        
        .tooltip-trigger:hover {
            opacity: 1;
        }
        
        .tooltip-content {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: var(--space-2);
            padding: var(--space-3);
            background: var(--gray-900);
            color: var(--white);
            border-radius: var(--radius);
            font-size: 0.875rem;
            line-height: 1.4;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-lg);
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--gray-900);
        }
        
        .tooltip-container:hover .tooltip-content {
            opacity: 1;
            visibility: visible;
        }
        
        .form-field label {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-2);
        }
        
        /* User Guide Document Styles */
        .user-guide-document {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--space-8);
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            line-height: 1.7;
        }
        
        .guide-header {
            text-align: center;
            margin-bottom: var(--space-12);
            padding-bottom: var(--space-8);
            border-bottom: 3px solid var(--primary);
        }
        
        .guide-header h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: var(--space-4);
            font-weight: 700;
        }
        
        .guide-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            font-weight: 400;
            margin: 0;
        }
        
        .guide-toc {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-10);
        }
        
        .guide-toc h2 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: var(--space-4);
            font-weight: 600;
        }
        
        .guide-toc ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-2);
        }
        
        .guide-toc li {
            margin: 0;
        }
        
        .toc-link {
            display: block;
            padding: var(--space-3) var(--space-4);
            color: var(--gray-700);
            text-decoration: none;
            border-radius: var(--radius);
            transition: var(--transition-fast);
            font-weight: 500;
        }
        
        .toc-link:hover {
            background: var(--primary-light);
            color: var(--primary);
            transform: translateX(5px);
        }
        
        .guide-section {
            margin-bottom: var(--space-12);
            scroll-margin-top: var(--space-8);
        }
        
        .guide-section h2 {
            color: var(--primary);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--primary-light);
        }
        
        .guide-content-section {
            margin-bottom: var(--space-8);
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
            padding: var(--space-6);
            border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
        }
        
        .guide-content-section h3 {
            color: var(--primary-dark);
            font-size: 1.375rem;
            font-weight: 600;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .guide-content-section h3:before {
            content: "📖";
            font-size: 1.25rem;
        }
        
        .guide-content-section .guide-text {
            color: var(--gray-800);
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .guide-content-section .guide-text p {
            margin-bottom: var(--space-4);
        }
        
        .guide-content-section .guide-text p:last-child {
            margin-bottom: 0;
        }
        
        .guide-content-section .guide-text strong {
            color: var(--gray-900);
            font-weight: 600;
        }
        
        /* Responsive adjustments for guide */
        @media (max-width: 768px) {
            .user-guide-document {
                padding: var(--space-4);
            }
            
            .guide-header h1 {
                font-size: 2rem;
            }
            
            .guide-toc ul {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1>🏦 XYZ Custody Forms</h1>
                <nav>
                    <button class="nav-button" onclick="showFormsListPage()" id="nav-forms">
                        <span>📋</span> My Forms
                    </button>
                    <button class="nav-button" onclick="showNewFormPage()" id="nav-new">
                        <span>✨</span> New Form
                    </button>
                </nav>
            </div>
        </header>

        <main class="app-main">
            <!-- Forms List Page -->
            <div id="forms-list-page">
                <div class="header" style="text-align: center; margin-bottom: 3rem;">
                    <h2 style="color: #495057; margin-bottom: 1rem; font-size: 2rem;">Manage Your Forms</h2>
                    <button class="btn-primary" onclick="showNewFormPage()">➕ Create New Form</button>
                </div>

                <!-- Enhanced Search and Filter Controls -->
                <div class="forms-controls" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 8px 30px rgba(0,0,0,0.1);">
                    <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 1rem; align-items: center;">
                        <!-- Search Bar -->
                        <div class="search-container" style="position: relative;">
                            <input 
                                type="text" 
                                id="search-input" 
                                placeholder="🔍 Search forms by client name, status, or content..." 
                                style="width: 100%; padding: 0.75rem 1rem 0.75rem 3rem; border: 2px solid #e9ecef; border-radius: 25px; font-size: 1rem; transition: all 0.3s ease;"
                                oninput="handleSearch()"
                                onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 3px rgba(0,123,255,0.1)'"
                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                            <div style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: #6c757d;">🔍</div>
                        </div>
                        
                        <!-- Status Filter -->
                        <select id="status-filter" onchange="handleFilter()" style="padding: 0.75rem 1rem; border: 2px solid #e9ecef; border-radius: 8px; background: white; cursor: pointer;">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="completed">Completed</option>
                            <option value="submitted">Submitted</option>
                        </select>
                        
                        <!-- Sort Options -->
                        <select id="sort-options" onchange="handleSort()" style="padding: 0.75rem 1rem; border: 2px solid #e9ecef; border-radius: 8px; background: white; cursor: pointer;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="name">Client Name A-Z</option>
                            <option value="name-desc">Client Name Z-A</option>
                            <option value="progress">Progress High-Low</option>
                            <option value="progress-low">Progress Low-High</option>
                        </select>
                        
                        <!-- View Toggle -->
                        <div class="view-toggle" style="display: flex; background: #f8f9fa; border-radius: 8px; padding: 0.25rem;">
                            <button id="grid-view" onclick="setViewMode('grid')" class="view-btn active" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; background: #007bff; color: white; font-size: 0.9rem;">📊 Cards</button>
                            <button id="list-view" onclick="setViewMode('list')" class="view-btn" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; background: transparent; color: #6c757d; font-size: 0.9rem;">📋 List</button>
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div id="active-filters" style="margin-top: 1rem; display: none;">
                        <div style="color: #495057; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 600;">Active Filters:</div>
                        <div id="filter-tags" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                    </div>
                    
                    <!-- Results Summary -->
                    <div id="results-summary" style="margin-top: 1rem; color: #6c757d; font-size: 0.9rem; text-align: center;"></div>
                </div>

                <div id="forms-container" class="forms-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading forms...</p>
                    </div>
                </div>
            </div>

            <!-- New Form Page -->
            <div id="new-form-page" class="hidden">
                <div class="form-editor">
                    <div class="editor-header">
                        <h2>Create New XYZ Custody Account Opening Form</h2>
                        <div style="margin-top: 1rem;">
                            <button class="btn-secondary" onclick="showFormsListPage()">← Back to Forms</button>
                        </div>
                    </div>

                    <!-- Form Tabs -->
                    <div class="form-tabs">
                        <button class="tab-button active" onclick="switchTab(0)" id="tab-0">AOF Page 1</button>
                        <button class="tab-button" onclick="switchTab(1)" id="tab-1">AOF Page 2</button>
                        <button class="tab-button" onclick="switchTab(2)" id="tab-2">Additional SWIFTs</button>
                        <button class="tab-button" onclick="switchTab(3); console.log('User Guide tab clicked');" id="tab-3">User Guide</button>
                    </div>

                    <div class="tab-content">
                        <form id="custody-form">
                            <div id="form-content">
                                <!-- Dynamic content will be loaded here -->
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Loading form structure...</p>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-secondary" onclick="resetForm()">🔄 Reset Form</button>
                                <button type="submit" class="btn-primary">💾 Save Form</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Application state
        let currentPage = 'forms-list';
        let currentTab = 0;
        let forms = [];
        let formMetadata = null;

        // Navigation
        function showFormsListPage() {
            console.log('Showing forms list page');
            currentPage = 'forms-list';
            
            const formsListPage = document.getElementById('forms-list-page');
            const newFormPage = document.getElementById('new-form-page');
            const navForms = document.getElementById('nav-forms');
            const navNew = document.getElementById('nav-new');
            
            if (formsListPage) formsListPage.classList.remove('hidden');
            if (newFormPage) newFormPage.classList.add('hidden');
            if (navForms) navForms.classList.add('active');
            if (navNew) navNew.classList.remove('active');
            
            loadForms();
        }

        function showNewFormPage() {
            console.log('Showing new form page');
            currentPage = 'new-form';
            
            const formsListPage = document.getElementById('forms-list-page');
            const newFormPage = document.getElementById('new-form-page');
            const navForms = document.getElementById('nav-forms');
            const navNew = document.getElementById('nav-new');
            
            if (formsListPage) formsListPage.classList.add('hidden');
            if (newFormPage) newFormPage.classList.remove('hidden');
            if (navForms) navForms.classList.remove('active');
            if (navNew) navNew.classList.add('active');
            
            if (!formMetadata) {
                loadFormMetadata();
            } else {
                renderFormContent();
            }
        }

        // Tab switching
        function switchTab(tabIndex) {
            console.log('switchTab called with index:', tabIndex);
            currentTab = tabIndex;
            console.log('currentTab set to:', currentTab);
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach((btn, index) => {
                if (index === tabIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            renderFormContent();
        }

        // Load form metadata
        async function loadFormMetadata() {
            try {
                console.log('Loading form metadata...');
                const response = await fetch('/form-metadata.json');
                formMetadata = await response.json();
                console.log('Metadata loaded:', formMetadata);
                renderFormContent();
            } catch (error) {
                console.error('Error loading metadata:', error);
                document.getElementById('form-content').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: #dc3545;">Error loading form structure</div>';
            }
        }

        // Get tooltip content for a specific field based on User Guide
        function getTooltipContent(fieldName) {
            const tooltipMap = {
                // Section 1: General Account Information
                'bbhAccountNumberReserved': 'Select Yes if you already have a reserved XYZ account number for this account opening.',
                'bbhAccountNumber': 'Enter the 7-digit XYZ account number that was reserved for this account opening.',
                'newAccountNameLegal': 'Account Legal Title is used to identify an account. Can have limit of 228 characters total. Should include client\'s full legal name and full legal names of related parties.',
                'shortAccountName': 'Shortened version displayed in XYZ Infuse and Wire Transfers. 30 character limit. Should be unique and recognizable.',
                'contactName': 'Primary contact person for this account who will receive communications and notifications.',
                'contactEmail': 'Email address for the primary contact person. This will be used for account notifications and communications.',
                'contactPhone': 'Phone number for the primary contact person. Include country and area codes for international numbers.',
                
                // Section 2: Account Services
                'foreignExchangeServices': 'Select if you need Foreign Exchange services with XYZ. This will enable FX trading capabilities for your account.',
                'cashServices': 'Select if you need Cash services. Required for cash-only accounts and accounts handling cash transactions.',
                'physicalServices': 'Select if you need Physical custody services for holding and safekeeping securities.',
                'custodyServices': 'Select if you need Custody services for securities safekeeping, settlement, and administration.',
                
                // Section 3: Global Custody Markets and Cash
                'currencyPreferences': 'Select required currencies for your account. Missing currencies may delay account availability. Choose based on your investment and settlement needs.',
                'marketPreferences': 'Select required markets for custody services. It is important to avoid missing or unnecessary markets as some require more than a business day to open.',
                'euroclearClearstream': 'Select required currencies for International Central Securities Depository (Euroclear/Clearstream) if you trade international fixed income.',
                'clsSetup': 'Select "Yes" if account requires setup in Continuous Linked Settlement foreign exchange settlement system for FX risk mitigation.',
                
                // Section 4: Tax Treatment
                'taxClassification': 'Entity type classification for U.S. tax purposes. Enter your tax classification from IRS Form W-8/W-9 (Individual, Corporation, Trust, Partnership, etc.).',
                'fatcaClassification': 'FATCA classification determines withholding requirements. FFI (Foreign Financial Institution), NFFE (Non-Financial Foreign Entity), or Neither.',
                'taxDomicileCountry': 'Country where account holder is considered tax resident. For U.S. accounts, enter actual state of residence rather than "U.S."',
                'taxpayerIdNumber': 'Local Taxpayer Identification Number. For U.S. citizens living outside U.S., provide U.S. TIN and enter "United States" as domicile.',
                'fatcaWithholding': 'FATCA withholding rate. If not populated, XYZ will determine based on tax documents provided or apply default treatment.',
                
                // Section 5: Foreign Exchange  
                'fxTradingActivity': 'FX trading activity setup can be modeled after existing account. Select execution methods and confirmation preferences.',
                'fxConfirmationMethod': 'Method for FX trade confirmations: SWIFT MT300, Email, or third-party vendor platforms (MISYS, GTSS, FXAll, Bloomberg).',
                'tradingCounterpartyInfo': 'Trading counterparty information cannot be modeled and must be provided manually. Required for XYZ\'s FX regulatory reporting.',
                
                // Mailing and Address fields
                'mailingFormat': 'Delivery methods: SWIFT delivery, Infuse (digital), or Both. Preferred option is Digital Copy via Infuse portal.',
                'infuseUserId': 'Required when Infuse mailing is selected. Your Infuse portal user ID for receiving digital statements and confirmations.',
                'wireTransferSwiftCode': 'SWIFT/BIC code for wire transfers. 8 or 11 characters. Contact name will be populated with account Short Title.',
                'billingAddress': 'Billing information for invoicing purposes. Can use same address as tax documentation mailing or provide different address.',
                
                // SWIFT Message Types
                'mt950Options': 'MT950 Customer Statement options with different aggregation levels (Ledger/Head account aggregated or segregated).',
                'swiftMessages': 'SWIFT message types for trade confirmations: MT513 (intraday execution advice) or MT515 (batch purchase/sale confirmation).',
                'mt535StatementOfPositions': 'MT535 Statement of Positions frequency: Daily, Weekly, Monthly, Daily on activity, Always daily, or Quarterly.',
                
                // Additional common fields
                'primaryAddress': 'Primary mailing address for account correspondence and regulatory communications.',
                'secondaryAddress': 'Secondary address if different from primary address for specific document types.',
                'accountType': 'Account type determined by Services (Cash/Custody) and Markets/Currencies selected. Types: Cash Only, U.S. Custody Only, Global Custody.',
                'additionalServices': 'Additional services beyond basic custody: Corporate Actions, Proxy Services, Tax Relief, Income Processing, etc.'
            };
            
            return tooltipMap[fieldName] || null;
        }

        // Generate tooltip HTML
        function generateTooltipHTML(tooltipContent) {
            if (!tooltipContent) return '';
            
            return `
                <div class="tooltip-container">
                    <span class="tooltip-trigger">?</span>
                    <div class="tooltip-content">${tooltipContent}</div>
                </div>
            `;
        }

        // Render form content based on current tab
        function renderFormContent() {
            console.log('renderFormContent called, currentTab:', currentTab);
            if (!formMetadata) {
                console.log('No formMetadata available');
                return;
            }
            
            // Debug: show all tab names
            console.log('All tabs:', formMetadata.tabs.map((tab, i) => `${i}: ${tab.name}`));
            
            const container = document.getElementById('form-content');
            const currentTabData = formMetadata.tabs[currentTab];
            console.log('currentTabData:', currentTabData);
            
            if (!currentTabData || !currentTabData.sections) {
                console.log('No currentTabData or sections');
                container.innerHTML = '<div style="text-align: center; padding: 2rem;">No content available for this tab</div>';
                return;
            }
            
            // Special handling for User Guide tab
            if (currentTabData.name === 'User Guide' || currentTabData.name.includes('Guide') || currentTab === 3) {
                console.log('Rendering User Guide tab:', currentTabData);
                renderUserGuide(currentTabData, container);
                return;
            }
            console.log('Rendering regular tab:', currentTabData.name);
            
            let html = '<div class="form-sections">';
            
            currentTabData.sections.forEach(section => {
                html += `
                    <div class="form-section">
                        <h3 class="section-title">
                            <span class="section-number">${section.number}</span>
                            ${section.title}
                        </h3>
                        <div class="section-fields">
                `;
                
                section.fields.forEach(field => {
                    html += renderField(field);
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Setup conditional logic after rendering
            setupConditionalLogic();
        }

        // Render User Guide as a document instead of form fields
        function renderUserGuide(guideData, container) {
            console.log('renderUserGuide called with:', guideData);
            
            // Create a proper User Guide since the Excel data is corrupted
            const properUserGuide = {
                sections: [
                    {
                        title: "📋 Introduction",
                        content: "The purpose of this guide is to assist clients in the completion of the XYZ Custody Account Opening Form. This form should be completed and sent to your client service team along with an instruction to open the account. It is recommended the form be password protected, with the password sent in a separate email."
                    },
                    {
                        title: "⚡ How the Form Works",
                        content: "This form uses conditional logic - initial selections will trigger next available fields or sub-sections to appear for input. Please ensure to input information in all available sections to complete the setup. All mandatory fields are marked in yellow or with a red marker. Use your mouse to click and navigate rather than using the ENTER button."
                    },
                    {
                        title: "🏢 1. General Account Information",
                        content: "<strong>New Account Name (Long Name - Legal Title):</strong> Account Legal Title is used to identify an account. Can have limit of 228 characters total. Should include client's full legal name.<br><br><strong>Short New Account Name:</strong> Shortened version displayed in XYZ Infuse and Wire Transfers. 30 character limit. Should be unique and recognizable.<br><br><strong>Contact Information:</strong> Primary contact person for this account who will receive communications and notifications."
                    },
                    {
                        title: "⚙️ 2. Account Services",
                        content: "Select all services which need to be added to the new account. The account type will be defined based on your selections of Services (Cash and/or Custody) and Markets/Currencies in Section 3.<br><br><strong>Available Account Types:</strong><br>• Cash Only Account<br>• U.S. Custody Only Account<br>• Global Custody Account<br><br>Services selected should match the services contracted with XYZ."
                    },
                    {
                        title: "🌍 3. Global Custody Markets and Cash",
                        content: "Select the required markets and currencies for your account. It is important to avoid any missing or unnecessary markets or currencies. Missing markets may incur a delay in availability of the account.<br><br><strong>Key Considerations:</strong><br>• Non-Registration Markets: Select required markets and currencies<br>• Registration Markets: Refer to Registration Kits within XYZ Infuse<br>• Euroclear/Clearstream: Select required currencies for ICSD<br>• CLS: Select if account requires Continuous Linked Settlement setup"
                    },
                    {
                        title: "💰 4. Intended Tax Treatment",
                        content: "<strong>Cash Only Accounts:</strong> Require Taxpayer Identification section to be populated with Taxpayer Title, Local Taxpayer ID Number, and Address.<br><br><strong>Important Notes:</strong><br>• For U.S. accounts, enter actual state of residence rather than 'U.S.'<br>• For U.S. citizens living outside U.S., enter 'United States'<br>• Enter tax classification from IRS Form W-8/W-9<br>• FATCA withholding may apply if proper documentation not provided<br><br><strong>Custody Accounts:</strong> First question identifies account structure (Direct vs. Intermediary)."
                    },
                    {
                        title: "💱 5. Foreign Exchange with XYZ",
                        content: "This section appears when Foreign Exchange service is selected in Section 2.<br><br><strong>FX Trading Activity:</strong> Can be modeled after existing account<br><strong>Trading Counterparty Info:</strong> Cannot be modeled, details must be provided manually<br><br><strong>Execution Methods:</strong><br>• Negotiated FX Execution - Active Execution<br>• Non-Negotiated Execution<br><br><strong>Confirmation Methods:</strong><br>• SWIFT MT300<br>• Email<br>• Third-party vendor platforms (MISYS, GTSS, FXAll, Bloomberg)"
                    },
                    {
                        title: "💳 6. Cash Posting Transactions",
                        content: "Select these options if any cash or custody flows should be posted from the head account to another XYZ account number. This section can be modeled after existing accounts. Required for U.S. Custody Only Accounts as USD cash transform for all transactions is required."
                    },
                    {
                        title: "📮 7. Mailing Products",
                        content: "Delivery methods supported include paper statements, SWIFT delivery, email, and Infuse. The delivery methods available vary by mailing product.<br><br><strong>Cash Service Mailing:</strong> Preferred option is Digital Copy via Infuse portal<br><strong>Custody Service Mailing:</strong> Preferred option is Digital Copy via Infuse portal - Statements Online<br><br>Contact your client service team to discuss any custom delivery methods."
                    },
                    {
                        title: "🏦 8. Wire Transfer Address",
                        content: "Wire transfer address is required for electronic transfer of funds. The contact name will be populated with the Short Title of the account. Address should not include PO Box or words 'Personal' or 'Confidential'. Option to use same address as tax documentation mailing from Section 4."
                    },
                    {
                        title: "🧾 9. Billing Address",
                        content: "Please input billing information for invoicing purposes. Option to use same address as tax documentation mailing from Section 4, or provide different address when 'Other' is selected."
                    },
                    {
                        title: "💰 10. Cash Accounting",
                        content: "XYZ's Contractual Cash Program for USD is a settlement valuation option for funds management. Gives 'as of' contractual value on 'vs. payment' security settlements. Allows clients to commit to security sale proceeds prior to settlement while avoiding overdraft charges. For more information, see Custody Client Guide in Infuse."
                    },
                    {
                        title: "📈 11. Trades - Custody",
                        content: "This section is visible only if Custody service is selected in Section 2.<br><br><strong>11.1 Trades Authorization:</strong> BIC addresses (8 or 11 characters) authorized for payments or trades. Authorized Persons Document required.<br><br><strong>11.2 Custody Security Instructions:</strong><br>• Client Duplicate Check options<br>• Depository Movement Service<br>• DNR Money tolerance<br>• Holiday Service<br>• Fed 50 million<br>• Return Delivery Service (RTD)<br><br><strong>11.3 SWIFTs for Trades & Position Reporting:</strong> SWIFT/BIC addresses for delivery<br><br><strong>11.4 Shareholder Rights Directive II:</strong> Account classification for SRDII compliance"
                    },
                    {
                        title: "💸 12. Payments - Cash",
                        content: "<strong>12.1 Payments Authorization:</strong> BIC addresses (8 or 11 characters) authorized for payments or trades. XYZ Infuse portal provides ability to execute and authorize payments.<br><br><strong>12.2 SWIFTs for Cash:</strong> SWIFT/BIC addresses for cash-related SWIFT delivery. Complete Additional SWIFT section if multiple BIC addresses with different requirements needed."
                    },
                    {
                        title: "📊 13. FWDP - Allow MT304 Forward Processing",
                        content: "BIC addresses (8 or 11 characters) authorized for MT304 forward processing. XYZ will require Authorized Persons Document. Indicate if any BIC addresses are for third parties (e.g., subadvisor)."
                    },
                    {
                        title: "🏢 14. Corporate Actions",
                        content: "Comprehensive corporate actions services including:<br><br><strong>14.1 Contacts Information:</strong> Primary, Escalation and Fax back contacts required<br><strong>14.2 Notification Receipt Methods:</strong> ActionView®, SWIFT, or fax<br><strong>14.3 Notification Products:</strong> Eligibility Date Notices for various action types<br><strong>14.4-14.18 Additional Services:</strong><br>• Odd Lot Tenders Processing<br>• Response Standing Instructions<br>• Cash Dividends Service<br>• Currency Options Service<br>• Restricted Security Exchange Offers<br>• Certifications Standing Instructions<br>• Response Reconciliation Report<br>• Pre-payment Advice<br>• MT566 Payment Confirmation<br>• Provisional Income Program<br>• Income Reclassification Service<br>• Proxy Information"
                    },
                    {
                        title: "📈 15. Fund Order & Custody",
                        content: "<strong>15.1 Fund Order & Custody Information:</strong> Fund order and custody services setup<br><br><strong>15.2 Prospectus:</strong> Address for Mutual Fund Prospectus mailing. Email address required if suppressing hard copy.<br><br><strong>15.3 Service Mailing Products:</strong> MFPS Confirmation delivery methods:<br>• Hard copy mailing (up to 3 addresses)<br>• Email<br>• SWIFT (MT515)<br><br>For Fund Order & Custody services, select required currencies for settlement of Fund Orders."
                    },
                    {
                        title: "❓ Additional Help",
                        content: "<strong>For additional assistance:</strong><br>• Hover over the ℹ️ icon next to field labels for specific guidance<br>• Contact your Client Service Representative for complex requirements<br>• Review detailed documentation in XYZ Infuse<br>• Use mouse to navigate rather than ENTER button<br><br><strong>Contact:</strong> If you have questions about this guide or process, contact your client service team."
                    }
                ]
            };
            
            try {
                let html = `
                    <div class="user-guide-document">
                        <div class="guide-header">
                            <h1>📚 XYZ Custody Account Opening Form - User Guide</h1>
                            <p class="guide-subtitle">Complete guidance for filling out your account opening form</p>
                        </div>
                        
                        <div class="guide-toc">
                            <h2>📋 Table of Contents</h2>
                            <ul>
                `;
                
                // Generate table of contents
                properUserGuide.sections.forEach((section, index) => {
                    html += `<li><a href="#guide-section-${index}" class="toc-link">${section.title}</a></li>`;
                });
                
                html += `
                            </ul>
                        </div>
                `;
                
                // Generate all sections
                properUserGuide.sections.forEach((section, index) => {
                    html += `
                        <div class="guide-section" id="guide-section-${index}">
                            <h2>${section.title}</h2>
                            <div class="guide-content-section">
                                <div class="guide-text">
                                    <p>${section.content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                console.log('Generated proper User Guide HTML length:', html.length);
                container.innerHTML = html;
                setupGuideNavigation();
                
            } catch (error) {
                console.error('Error rendering User Guide:', error);
                container.innerHTML = `<div style="padding: 2rem; color: red;">Error rendering User Guide: ${error.message}</div>`;
            }
        }

        // Setup guide navigation
        function setupGuideNavigation() {
            document.querySelectorAll('.toc-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        }

        // Render individual field
        function renderField(field) {
            const conditionalClass = field.conditional ? 'conditional-field' : '';
            const conditionalId = field.conditional ? `conditional-${field.name}` : '';
            const tooltipContent = getTooltipContent(field.name);
            const tooltipHTML = generateTooltipHTML(tooltipContent);
            
            let fieldHtml = `<div class="form-field ${conditionalClass}" id="${conditionalId}" data-field="${field.name}">`;
            
            switch (field.type) {
                case 'text':
                case 'email':
                case 'tel':
                    fieldHtml += `
                        <label for="${field.name}">
                            ${field.label}${field.required ? ' *' : ''}
                            ${tooltipHTML}
                        </label>
                        <input 
                            type="${field.type}" 
                            id="${field.name}" 
                            name="${field.name}"
                            ${field.required ? 'required' : ''}
                            ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}
                            ${field.pattern ? `pattern="${field.pattern}"` : ''}
                            placeholder="${field.helpText || ''}"
                            onchange="handleFieldChange('${field.name}')">
                    `;
                    break;
                    
                case 'textarea':
                    fieldHtml += `
                        <label for="${field.name}">
                            ${field.label}${field.required ? ' *' : ''}
                            ${tooltipHTML}
                        </label>
                        <textarea 
                            id="${field.name}" 
                            name="${field.name}"
                            ${field.required ? 'required' : ''}
                            ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}
                            placeholder="${field.helpText || ''}"
                            onchange="handleFieldChange('${field.name}')"></textarea>
                    `;
                    break;
                    
                case 'radio':
                    fieldHtml += `
                        <label class="field-label">
                            ${field.label}${field.required ? ' *' : ''}
                            ${tooltipHTML}
                        </label>
                        <div class="radio-group">
                    `;
                    field.options.forEach(option => {
                        fieldHtml += `
                            <div class="radio-option">
                                <input 
                                    type="radio" 
                                    id="${field.name}_${option}" 
                                    name="${field.name}" 
                                    value="${option}"
                                    onchange="handleFieldChange('${field.name}')">
                                <label for="${field.name}_${option}">${option}</label>
                            </div>
                        `;
                    });
                    fieldHtml += '</div>';
                    break;
                    
                case 'guide-content':
                    fieldHtml += `
                        <div class="guide-content">
                            <h4>${field.label}</h4>
                            <div class="guide-text">${field.content}</div>
                        </div>
                    `;
                    break;
                    
                case 'checkbox':
                    fieldHtml += `
                        <div class="checkbox-option">
                            <input 
                                type="checkbox" 
                                id="${field.name}" 
                                name="${field.name}"
                                onchange="handleFieldChange('${field.name}')">
                            <label for="${field.name}">
                                ${field.label}
                                ${tooltipHTML}
                            </label>
                        </div>
                    `;
                    break;
                    
                case 'checkbox-with-options':
                    fieldHtml += `
                        <div class="checkbox-option">
                            <input 
                                type="checkbox" 
                                id="${field.name}" 
                                name="${field.name}"
                                onchange="handleFieldChange('${field.name}')">
                            <label for="${field.name}">
                                ${field.label}
                                ${tooltipHTML}
                            </label>
                        </div>
                    `;
                    if (field.conditionalOptions && field.conditionalOptions.length > 0) {
                        fieldHtml += `
                            <div class="conditional-options" id="conditional-${field.name}" style="display: none; margin-top: 1rem; margin-left: 2rem;">
                                <div class="help-text" style="margin-bottom: 0.5rem;">${field.helpText || 'Please select frequency:'}</div>
                                <div class="checkbox-group">
                        `;
                        field.conditionalOptions.forEach(option => {
                            fieldHtml += `
                                <div class="checkbox-option">
                                    <input 
                                        type="checkbox" 
                                        id="${field.name}_${option}" 
                                        name="${field.name}_options" 
                                        value="${option}"
                                        onchange="handleFieldChange('${field.name}')">
                                    <label for="${field.name}_${option}">${option}</label>
                                </div>
                            `;
                        });
                        fieldHtml += `
                                </div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'dropdown':
                    fieldHtml += `
                        <label for="${field.name}">
                            ${field.label}${field.required ? ' *' : ''}
                            ${tooltipHTML}
                        </label>
                        <select 
                            id="${field.name}" 
                            name="${field.name}"
                            ${field.required ? 'required' : ''}
                            onchange="handleFieldChange('${field.name}')">
                            <option value="">Select an option...</option>
                    `;
                    field.options.forEach(option => {
                        fieldHtml += `<option value="${option}">${option}</option>`;
                    });
                    fieldHtml += '</select>';
                    break;
                    
                case 'multiselect':
                    fieldHtml += `
                        <label class="field-label">
                            ${field.label}${field.required ? ' *' : ''}
                            ${tooltipHTML}
                        </label>
                        <div class="multiselect-group">
                    `;
                    field.options.forEach(option => {
                        fieldHtml += `
                            <div class="multiselect-option">
                                <input 
                                    type="checkbox" 
                                    id="${field.name}_${option}" 
                                    name="${field.name}" 
                                    value="${option}"
                                    onchange="handleMultiselectChange('${field.name}')">
                                <label for="${field.name}_${option}">${option}</label>
                            </div>
                        `;
                    });
                    fieldHtml += '</div>';
                    break;
                    
                case 'checkbox-group':
                    fieldHtml += `
                        <label class="field-label">
                            ${field.label}${field.required ? ' *' : ''}
                            ${tooltipHTML}
                        </label>
                        <div class="checkbox-group">
                    `;
                    if (field.options) {
                        field.options.forEach(option => {
                            fieldHtml += `
                                <div class="checkbox-option">
                                    <input 
                                        type="checkbox" 
                                        id="${field.name}_${option}" 
                                        name="${field.name}" 
                                        value="${option}"
                                        onchange="handleFieldChange('${field.name}')">
                                    <label for="${field.name}_${option}">${option}</label>
                                </div>
                            `;
                        });
                    }
                    fieldHtml += '</div>';
                    break;
                    
                default:
                    fieldHtml += `
                        <label for="${field.name}">${field.label}${field.required ? ' *' : ''}</label>
                        <input 
                            type="text" 
                            id="${field.name}" 
                            name="${field.name}"
                            ${field.required ? 'required' : ''}
                            onchange="handleFieldChange('${field.name}')">
                    `;
            }
            
            if (field.helpText) {
                fieldHtml += `<div class="help-text">${field.helpText}</div>`;
            }
            
            fieldHtml += '</div>';
            return fieldHtml;
        }

        // Handle field changes and conditional logic
        function handleFieldChange(fieldName) {
            console.log('Field changed:', fieldName);
            
            // Handle checkbox-with-options type
            const checkbox = document.getElementById(fieldName);
            const conditionalOptions = document.getElementById(`conditional-${fieldName}`);
            
            if (checkbox && conditionalOptions) {
                if (checkbox.checked) {
                    conditionalOptions.style.display = 'block';
                } else {
                    conditionalOptions.style.display = 'none';
                }
            }
            
            updateConditionalFields();
        }

        function handleMultiselectChange(fieldName) {
            console.log('Multiselect changed:', fieldName);
            updateConditionalFields();
        }

        // Setup and update conditional logic
        function setupConditionalLogic() {
            updateConditionalFields();
        }

        function updateConditionalFields() {
            if (!formMetadata) return;
            
            const currentTabData = formMetadata.tabs[currentTab];
            if (!currentTabData || !currentTabData.sections) return;
            
            currentTabData.sections.forEach(section => {
                section.fields.forEach(field => {
                    if (field.conditional) {
                        const shouldShow = evaluateConditional(field.conditional);
                        const fieldElement = document.getElementById(`conditional-${field.name}`);
                        
                        if (fieldElement) {
                            if (shouldShow) {
                                fieldElement.classList.remove('hidden');
                            } else {
                                fieldElement.classList.add('hidden');
                            }
                        }
                    }
                });
            });
        }

        function evaluateConditional(conditional) {
            const triggerField = document.querySelector(`[name="${conditional.field}"]`);
            if (!triggerField) return false;
            
            let fieldValue;
            if (triggerField.type === 'checkbox') {
                fieldValue = triggerField.checked;
            } else if (triggerField.type === 'radio') {
                const checkedRadio = document.querySelector(`[name="${conditional.field}"]:checked`);
                fieldValue = checkedRadio ? checkedRadio.value : null;
            } else {
                fieldValue = triggerField.value;
            }
            
            switch (conditional.operator) {
                case 'equals':
                    return conditional.showWhen ? fieldValue === conditional.value : fieldValue !== conditional.value;
                case 'in':
                    const isInArray = Array.isArray(conditional.value) && conditional.value.includes(fieldValue);
                    return conditional.showWhen ? isInArray : !isInArray;
                case 'not_equals':
                    return conditional.showWhen ? fieldValue !== conditional.value : fieldValue === conditional.value;
                default:
                    return true;
            }
        }

        // Form submission and management
        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                document.getElementById('custody-form').reset();
                updateConditionalFields();
            }
        }

        // API functions for forms list
        async function loadForms() {
            try {
                console.log('Loading forms...');
                const response = await fetch('/api/forms');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                forms = await response.json();
                console.log('Loaded forms:', forms);
                renderForms();
            } catch (error) {
                console.error('Error loading forms:', error);
                document.getElementById('forms-container').innerHTML = 
                    `<div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <h3>Error loading forms</h3>
                        <p>${error.message}</p>
                        <button class="btn-primary" onclick="loadForms()">Retry</button>
                    </div>`;
            }
        }

        // Enhanced forms management with search, filter, and view modes
        let filteredForms = [];
        let currentViewMode = 'grid';
        
        function renderForms(formsToRender = forms) {
            console.log('Rendering forms, count:', formsToRender?.length || 0);
            const container = document.getElementById('forms-container');
            filteredForms = formsToRender || [];
            
            // Update results summary
            updateResultsSummary(filteredForms.length, forms?.length || 0);
            
            if (!filteredForms || filteredForms.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 4rem; background: white; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1);">
                        <div style="font-size: 4rem; margin-bottom: 2rem;">📋</div>
                        <h3 style="color: #495057; margin-bottom: 1rem;">${forms?.length > 0 ? 'No forms match your search' : 'No Forms Yet'}</h3>
                        <p style="color: #6c757d; margin-bottom: 2rem;">${forms?.length > 0 ? 'Try adjusting your search or filters.' : 'Create your first XYZ Custody Account Opening Form to get started.'}</p>
                        ${forms?.length > 0 ? '<button class="btn-secondary" onclick="clearAllFilters()">Clear Filters</button>' : '<button class="btn-primary" onclick="showNewFormPage()">Create New Form</button>'}
                    </div>
                `;
                return;
            }

            // Update container class based on view mode
            container.className = currentViewMode === 'grid' ? 'forms-grid' : 'forms-list';
            
            if (currentViewMode === 'grid') {
                container.innerHTML = filteredForms.map(form => renderFormCard(form)).join('');
            } else {
                container.innerHTML = filteredForms.map(form => renderFormListItem(form)).join('');
            }
        }
        
        function renderFormCard(form) {
            const completionPercentage = calculateCompletionPercentage(form);
            const formDataPreview = getFormDataPreview(form);
            
            return `
                <div class="form-card" style="position: relative; overflow: hidden;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: #495057; font-size: 1.3rem;">${form.clientName}</h3>
                            <div style="font-size: 0.85rem; color: #6c757d;">${form.id.substring(0, 8)}...</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${getStatusBadge(form.status)}
                            <div class="form-menu" style="position: relative;">
                                <button onclick="toggleFormMenu('${form.id}')" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.25rem;">⋮</button>
                                <div id="menu-${form.id}" class="form-menu-dropdown" style="display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 100; min-width: 150px;">
                                    <button onclick="viewFormDetails('${form.id}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa;">👁️ View Details</button>
                                    <button onclick="editForm('${form.id}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa;">✏️ Edit</button>
                                    <button onclick="duplicateForm('${form.id}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa;">📋 Duplicate</button>
                                    <button onclick="downloadForm('${form.id}', '${form.clientName}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa;">💾 Export</button>
                                    <button onclick="deleteForm('${form.id}', '${form.clientName}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; color: #dc3545;">🗑️ Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Data Preview -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: #495057; margin-bottom: 0.5rem;">Form Preview:</div>
                        <div style="font-size: 0.8rem; color: #6c757d; line-height: 1.4;">
                            ${formDataPreview}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; color: #6c757d; font-size: 0.9rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <span style="font-weight: 600;">Created:</span><br>
                                <span>${formatDate(form.createdDate)}</span>
                            </div>
                            <div>
                                <span style="font-weight: 600;">Modified:</span><br>
                                <span>${formatDate(form.lastModified)}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Progress:</span>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 100px; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; background: linear-gradient(90deg, ${getProgressColor(completionPercentage)}); width: ${completionPercentage}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-size: 0.9rem; font-weight: 600;">${completionPercentage}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="viewFormDetails('${form.id}')" style="padding: 0.5rem 1rem; font-size: 0.85rem; flex: 1;">👁️ View</button>
                        <button class="btn-secondary" onclick="downloadForm('${form.id}', '${form.clientName}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">💾</button>
                        <button onclick="deleteForm('${form.id}', '${form.clientName}')" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">🗑</button>
                    </div>
                </div>
            `;
        }
        
        function renderFormListItem(form) {
            const completionPercentage = calculateCompletionPercentage(form);
            const formDataPreview = getFormDataPreview(form);
            
            return `
                <div class="form-list-item" style="background: white; border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: grid; grid-template-columns: 2fr 1fr 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #495057;">${form.clientName}</h4>
                        <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 0.5rem;">${form.id.substring(0, 8)}...</div>
                        <div style="font-size: 0.75rem; color: #868e96;">${formDataPreview}</div>
                    </div>
                    <div style="text-align: center;">
                        ${getStatusBadge(form.status)}
                    </div>
                    <div style="text-align: center; font-size: 0.85rem; color: #6c757d;">
                        <div style="font-weight: 600;">Created</div>
                        <div>${formatDate(form.createdDate)}</div>
                        <div style="margin-top: 0.5rem; font-weight: 600;">Modified</div>
                        <div>${formatDate(form.lastModified)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: conic-gradient(${getProgressColor(completionPercentage)} ${completionPercentage * 3.6}deg, #e9ecef 0deg); display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            <div style="width: 45px; height: 45px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600;">${completionPercentage}%</div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button class="btn-secondary" onclick="viewFormDetails('${form.id}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">👁️ View</button>
                        <button class="btn-secondary" onclick="downloadForm('${form.id}', '${form.clientName}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">💾 Export</button>
                        <button onclick="deleteForm('${form.id}', '${form.clientName}')" style="padding: 0.4rem 0.8rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">🗑 Delete</button>
                    </div>
                </div>
            `;
        }

        // Helper functions for enhanced UI
        function calculateCompletionPercentage(form) {
            if (!form.formData || typeof form.formData !== 'object') return 0;
            
            let totalFields = 0;
            let completedFields = 0;
            
            Object.values(form.formData).forEach(section => {
                if (typeof section === 'object' && section !== null) {
                    Object.entries(section).forEach(([key, value]) => {
                        totalFields++;
                        if (value && value !== '' && value !== false) {
                            completedFields++;
                        }
                    });
                }
            });
            
            return totalFields === 0 ? 0 : Math.round((completedFields / totalFields) * 100);
        }
        
        function getFormDataPreview(form) {
            if (!form.formData) return 'No data available';
            
            const previews = [];
            Object.values(form.formData).forEach(section => {
                if (typeof section === 'object' && section !== null) {
                    Object.entries(section).forEach(([key, value]) => {
                        if (value && value !== '' && value !== false) {
                            const cleanKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                            const cleanValue = typeof value === 'boolean' ? (value ? 'Yes' : 'No') : String(value).substring(0, 30);
                            previews.push(`${cleanKey}: ${cleanValue}`);
                        }
                    });
                }
            });
            
            return previews.length > 0 ? previews.slice(0, 3).join(' • ') + (previews.length > 3 ? '...' : '') : 'No data available';
        }
        
        function getStatusBadge(status) {
            const statusConfig = {
                'draft': { bg: '#fff3cd', color: '#856404', icon: '📝' },
                'completed': { bg: '#d4edda', color: '#155724', icon: '✅' },
                'submitted': { bg: '#d1ecf1', color: '#0c5460', icon: '📤' }
            };
            
            const config = statusConfig[status] || statusConfig['draft'];
            return `<div style="padding: 0.4rem 0.8rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background-color: ${config.bg}; color: ${config.color}; display: flex; align-items: center; gap: 0.25rem;">
                ${config.icon} ${status.charAt(0).toUpperCase() + status.slice(1)}
            </div>`;
        }
        
        function getProgressColor(percentage) {
            if (percentage < 25) return '#dc3545, #dc3545';
            if (percentage < 50) return '#fd7e14, #ffc107';
            if (percentage < 75) return '#ffc107, #28a745';
            return '#28a745, #007bff';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
            
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        // Search and Filter Functions
        function handleSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            applyFilters();
        }
        
        function handleFilter() {
            applyFilters();
        }
        
        function handleSort() {
            applyFilters();
        }
        
        function applyFilters() {
            if (!forms) return;
            
            let filtered = [...forms];
            
            // Apply search filter
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(form => {
                    const clientName = form.clientName.toLowerCase();
                    const status = form.status.toLowerCase();
                    const formDataText = getFormDataPreview(form).toLowerCase();
                    const id = form.id.toLowerCase();
                    
                    return clientName.includes(searchTerm) || 
                           status.includes(searchTerm) || 
                           formDataText.includes(searchTerm) ||
                           id.includes(searchTerm);
                });
            }
            
            // Apply status filter
            const statusFilter = document.getElementById('status-filter').value;
            if (statusFilter) {
                filtered = filtered.filter(form => form.status === statusFilter);
            }
            
            // Apply sorting
            const sortOption = document.getElementById('sort-options').value;
            filtered.sort((a, b) => {
                switch (sortOption) {
                    case 'newest':
                        return new Date(b.createdDate) - new Date(a.createdDate);
                    case 'oldest':
                        return new Date(a.createdDate) - new Date(b.createdDate);
                    case 'name':
                        return a.clientName.localeCompare(b.clientName);
                    case 'name-desc':
                        return b.clientName.localeCompare(a.clientName);
                    case 'progress':
                        return calculateCompletionPercentage(b) - calculateCompletionPercentage(a);
                    case 'progress-low':
                        return calculateCompletionPercentage(a) - calculateCompletionPercentage(b);
                    default:
                        return 0;
                }
            });
            
            updateActiveFilters(searchTerm, statusFilter);
            renderForms(filtered);
        }
        
        function updateActiveFilters(searchTerm, statusFilter) {
            const activeFiltersContainer = document.getElementById('active-filters');
            const filterTagsContainer = document.getElementById('filter-tags');
            
            const activeTags = [];
            if (searchTerm) activeTags.push(`Search: "${searchTerm}"`);
            if (statusFilter) activeTags.push(`Status: ${statusFilter}`);
            
            if (activeTags.length > 0) {
                activeFiltersContainer.style.display = 'block';
                filterTagsContainer.innerHTML = activeTags.map(tag => 
                    `<span style="background: #e9ecef; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; color: #495057;">
                        ${tag} <button onclick="clearFilter('${tag.split(':')[0].toLowerCase()}')" style="background: none; border: none; margin-left: 0.5rem; cursor: pointer; color: #6c757d;">×</button>
                    </span>`
                ).join('');
            } else {
                activeFiltersContainer.style.display = 'none';
            }
        }
        
        function clearFilter(type) {
            if (type === 'search') {
                document.getElementById('search-input').value = '';
            } else if (type === 'status') {
                document.getElementById('status-filter').value = '';
            }
            applyFilters();
        }
        
        function clearAllFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('sort-options').value = 'newest';
            applyFilters();
        }
        
        function updateResultsSummary(filteredCount, totalCount) {
            const summary = document.getElementById('results-summary');
            if (filteredCount === totalCount) {
                summary.innerHTML = `Showing ${totalCount} form${totalCount !== 1 ? 's' : ''}`;
            } else {
                summary.innerHTML = `Showing ${filteredCount} of ${totalCount} form${totalCount !== 1 ? 's' : ''}`;
            }
        }
        
        // View Mode Functions
        function setViewMode(mode) {
            currentViewMode = mode;
            
            // Update button states
            document.getElementById('grid-view').className = mode === 'grid' ? 'view-btn active' : 'view-btn';
            document.getElementById('list-view').className = mode === 'list' ? 'view-btn active' : 'view-btn';
            
            // Update button styles
            if (mode === 'grid') {
                document.getElementById('grid-view').style.background = '#007bff';
                document.getElementById('grid-view').style.color = 'white';
                document.getElementById('list-view').style.background = 'transparent';
                document.getElementById('list-view').style.color = '#6c757d';
            } else {
                document.getElementById('list-view').style.background = '#007bff';
                document.getElementById('list-view').style.color = 'white';
                document.getElementById('grid-view').style.background = 'transparent';
                document.getElementById('grid-view').style.color = '#6c757d';
            }
            
            renderForms(filteredForms);
        }
        
        // Form Actions
        function toggleFormMenu(formId) {
            const menu = document.getElementById(`menu-${formId}`);
            const isVisible = menu.style.display !== 'none';
            
            // Close all other menus
            document.querySelectorAll('.form-menu-dropdown').forEach(m => m.style.display = 'none');
            
            menu.style.display = isVisible ? 'none' : 'block';
            
            // Close menu when clicking outside
            if (!isVisible) {
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!e.target.closest('.form-menu')) {
                            menu.style.display = 'none';
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }
        }
        
        function viewFormDetails(formId) {
            const form = forms.find(f => f.id === formId);
            if (!form) return;
            
            // Create and show detailed view modal
            showFormDetailsModal(form);
        }
        
        function showFormDetailsModal(form) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
                display: flex; align-items: center; justify-content: center; z-index: 1000;
            `;
            
            const completionPercentage = calculateCompletionPercentage(form);
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #f8f9fa; padding-bottom: 1rem;">
                        <h2 style="margin: 0; color: #495057;">Form Details</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">×</button>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #495057;">${form.clientName}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div><strong>Form ID:</strong> ${form.id}</div>
                            <div><strong>Status:</strong> ${getStatusBadge(form.status)}</div>
                            <div><strong>Created:</strong> ${formatDate(form.createdDate)}</div>
                            <div><strong>Last Modified:</strong> ${formatDate(form.lastModified)}</div>
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <strong>Completion Progress:</strong>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <div style="flex: 1; height: 12px; background: #e9ecef; border-radius: 6px; overflow: hidden;">
                                    <div style="height: 100%; background: linear-gradient(90deg, ${getProgressColor(completionPercentage)}); width: ${completionPercentage}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-weight: 600; min-width: 50px;">${completionPercentage}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #495057;">Form Data Summary:</h4>
                        <div style="font-size: 0.9rem; color: #6c757d; line-height: 1.6;">
                            ${getDetailedFormPreview(form)}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                        <button onclick="downloadForm('${form.id}', '${form.clientName}')" class="btn-secondary">💾 Export</button>
                        <button onclick="editForm('${form.id}')" class="btn-primary">✏️ Edit Form</button>
                        <button onclick="this.closest('.modal').remove()" class="btn-secondary">Close</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function getDetailedFormPreview(form) {
            if (!form.formData) return 'No form data available.';
            
            const sections = [];
            Object.entries(form.formData).forEach(([sectionKey, section]) => {
                if (typeof section === 'object' && section !== null) {
                    const fields = [];
                    Object.entries(section).forEach(([key, value]) => {
                        if (value && value !== '' && value !== false) {
                            const cleanKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                            const cleanValue = typeof value === 'boolean' ? (value ? 'Yes' : 'No') : String(value);
                            fields.push(`<strong>${cleanKey}:</strong> ${cleanValue}`);
                        }
                    });
                    
                    if (fields.length > 0) {
                        sections.push(`<div style="margin-bottom: 1rem;"><div style="font-weight: 600; color: #495057; margin-bottom: 0.5rem; text-transform: capitalize;">${sectionKey.replace(/([A-Z])/g, ' $1')}</div>${fields.join('<br>')}</div>`);
                    }
                }
            });
            
            return sections.length > 0 ? sections.join('') : 'No completed fields yet.';
        }
        
        function editForm(formId) {
            // Implement edit functionality
            console.log('Edit form:', formId);
            alert('Edit functionality would be implemented here');
        }
        
        function duplicateForm(formId) {
            // Implement duplicate functionality
            console.log('Duplicate form:', formId);
            alert('Duplicate functionality would be implemented here');
        }

        async function downloadForm(id, clientName) {
            try {
                const response = await fetch(`/api/forms/${id}/export`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `xyz-custody-form-${clientName.replace(/[^a-zA-Z0-9]/g, '_')}-${id.substring(0, 8)}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading form:', error);
                alert('Error downloading form');
            }
        }

        async function deleteForm(id, clientName) {
            if (!confirm(`Are you sure you want to delete the form for "${clientName}"?`)) return;
            
            try {
                await fetch(`/api/forms/${id}`, { method: 'DELETE' });
                loadForms();
            } catch (error) {
                console.error('Error deleting form:', error);
                alert('Error deleting form');
            }
        }

        // Form submission
        document.getElementById('custody-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            const multiselectFields = new Set();
            
            // Collect multiselect fields
            if (formMetadata && formMetadata.tabs[currentTab]) {
                formMetadata.tabs[currentTab].sections.forEach(section => {
                    section.fields.forEach(field => {
                        if (field.type === 'multiselect' || field.type === 'checkbox-group') {
                            multiselectFields.add(field.name);
                        }
                    });
                });
            }
            
            // Process form data
            for (let [key, value] of formData.entries()) {
                const field = this[key];
                
                if (multiselectFields.has(key)) {
                    if (!data[key]) data[key] = [];
                    data[key].push(value);
                } else if (field && field.type === 'checkbox') {
                    data[key] = field.checked;
                } else {
                    data[key] = value;
                }
            }
            
            // Handle unchecked checkboxes
            multiselectFields.forEach(fieldName => {
                if (!data[fieldName]) {
                    data[fieldName] = [];
                }
            });

            const payload = {
                clientName: data.newAccountNameLegal || data.clientName || 'Unnamed Client',
                status: 'draft',
                formData: {
                    [`tab${currentTab}`]: data
                }
            };

            try {
                const response = await fetch('/api/forms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save form');
                }
                
                alert('Form saved successfully!');
                showFormsListPage();
            } catch (error) {
                console.error('Error saving form:', error);
                alert('Error saving form: ' + error.message);
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized');
            showFormsListPage();
        });
    </script>
</body>
</html>