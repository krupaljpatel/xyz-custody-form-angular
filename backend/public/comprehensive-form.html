<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XYZ Custody Account Opening Form - Comprehensive v2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            /* Modern Color Palette */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            
            /* Base Colors */
            --primary: #667eea;
            --primary-light: rgba(102, 126, 234, 0.1);
            --primary-dark: #5a6fd8;
            --secondary: #6c757d;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            
            /* Neutral Colors */
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* Typography */
            --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', Monaco, Consolas, monospace;
            
            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            
            /* Transitions */
            --transition-fast: all 0.15s ease;
            --transition-normal: all 0.3s ease;
            --transition-slow: all 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-900);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            min-height: 100vh;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            min-height: 100vh;
        }

        .app-header {
            background: var(--white);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: var(--space-4) var(--space-8);
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .app-header nav {
            display: flex;
            gap: var(--space-2);
        }

        .nav-button {
            background: var(--white);
            color: var(--gray-700);
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
            overflow: hidden;
        }

        .nav-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: var(--transition-normal);
            z-index: -1;
        }

        .nav-button:hover::before,
        .nav-button.active::before {
            left: 0;
        }

        .nav-button:hover,
        .nav-button.active {
            color: var(--white);
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .app-main {
            padding: var(--space-8);
            max-width: 1400px;
            margin: 0 auto;
        }

        .forms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: var(--space-6);
        }
        
        .forms-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .form-card {
            background: var(--white);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            transition: var(--transition-normal);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition-normal);
        }

        .form-card:hover {
            box-shadow: var(--shadow-2xl);
            transform: translateY(-4px);
            border-color: var(--primary-light);
        }

        .form-card:hover::before {
            opacity: 1;
        }

        .form-editor {
            background: var(--white);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            overflow: hidden;
            margin: 0 auto;
            max-width: 1200px;
            border: 1px solid var(--gray-200);
            backdrop-filter: blur(20px);
        }

        .editor-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--space-8);
            text-align: center;
        }

        .editor-header h2 {
            margin: 0 0 var(--space-4) 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .form-tabs {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            overflow-x: auto;
            padding: 0 var(--space-4);
            gap: var(--space-2);
        }

        .tab-button {
            padding: var(--space-4) var(--space-6);
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-500);
            border-bottom: 2px solid transparent;
            transition: var(--transition-normal);
            white-space: nowrap;
            min-width: 150px;
            border-radius: var(--radius) var(--radius) 0 0;
            font-size: 0.875rem;
        }

        .tab-button:hover {
            background: var(--gray-100);
            color: var(--primary);
        }

        .tab-button.active {
            background: var(--white);
            color: var(--primary);
            border-bottom-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .tab-content {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .form-section {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .section-title {
            margin: 0 0 2rem 0;
            color: #007bff;
            font-size: 1.4rem;
            font-weight: 600;
            border-bottom: 3px solid #007bff;
            padding-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-number {
            background: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .section-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            background: var(--white);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            border: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            transition: var(--transition-normal);
            position: relative;
        }

        .form-field::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-gradient);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            opacity: 0;
            transition: var(--transition-normal);
        }

        .form-field:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
            border-color: var(--primary-light);
        }

        .form-field:hover::before {
            opacity: 1;
        }

        .form-field label {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.875rem;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .form-field label::before {
            content: '•';
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: bold;
        }

        .form-field input[type="text"],
        .form-field input[type="email"],
        .form-field input[type="tel"],
        .form-field textarea,
        .form-field select {
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            transition: var(--transition-normal);
            background: var(--gray-50);
            font-family: var(--font-primary);
        }

        .form-field input:focus,
        .form-field textarea:focus,
        .form-field select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
            background: var(--white);
        }

        .form-field input::placeholder,
        .form-field textarea::placeholder {
            color: var(--gray-400);
            font-style: italic;
        }

        .form-field textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Enhanced checkbox and radio styling with better indentation */
        .field-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.75rem;
        }

        .radio-group,
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1.5rem;
            background: rgba(0,123,255,0.02);
            border-radius: 12px;
            border-left: 4px solid #007bff;
            position: relative;
        }

        .radio-group::before,
        .checkbox-group::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #007bff, #0056b3);
            border-radius: 0 2px 2px 0;
        }

        .radio-option,
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            margin-left: 1rem;
            position: relative;
            min-height: 55px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .radio-option::before,
        .checkbox-option::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 25px;
            background: rgba(0,123,255,0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .radio-option:hover,
        .checkbox-option:hover {
            border-color: #007bff;
            background: rgba(0,123,255,0.08);
            transform: translateX(8px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.15);
        }

        .radio-option:hover::before,
        .checkbox-option:hover::before {
            background: #007bff;
            width: 4px;
            height: 35px;
        }

        .radio-option input[type="radio"],
        .checkbox-option input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin: 0;
            accent-color: #007bff;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .radio-option input[type="radio"]:checked,
        .checkbox-option input[type="checkbox"]:checked {
            transform: scale(1.1);
        }

        .radio-option label,
        .checkbox-option label {
            cursor: pointer;
            margin: 0;
            font-weight: 500;
            flex: 1;
            font-size: 1rem;
            color: #495057;
            line-height: 1.5;
        }

        .radio-option input:checked + label,
        .checkbox-option input:checked + label {
            color: #007bff;
            font-weight: 600;
        }

        .multiselect-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
            max-height: 250px;
            overflow-y: auto;
            padding: 1.5rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: rgba(0,123,255,0.02);
            border-left: 4px solid #28a745;
            position: relative;
        }

        .multiselect-group::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #28a745, #1e7e34);
            border-radius: 0 2px 2px 0;
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            border: 1px solid #e9ecef;
            min-height: 45px;
            margin-left: 0.5rem;
            position: relative;
        }

        .multiselect-option::before {
            content: '';
            position: absolute;
            left: -0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 20px;
            background: rgba(40, 167, 69, 0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .multiselect-option:hover {
            background: rgba(40, 167, 69, 0.08);
            border-color: #28a745;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
        }

        .multiselect-option:hover::before {
            background: #28a745;
            width: 3px;
            height: 30px;
        }

        .multiselect-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #28a745;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .multiselect-option input[type="checkbox"]:checked {
            transform: scale(1.1);
        }

        .multiselect-option label {
            cursor: pointer;
            margin: 0;
            font-size: 0.95rem;
            font-weight: 500;
            color: #495057;
            flex: 1;
            line-height: 1.4;
        }

        .multiselect-option input:checked + label {
            color: #28a745;
            font-weight: 600;
        }

        .help-text {
            color: #6c757d;
            font-size: 0.9rem;
            font-style: italic;
            margin-top: 0.25rem;
            padding-left: 0.5rem;
            border-left: 3px solid #dee2e6;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%);
            transition: var(--transition-normal);
        }

        .btn-primary:hover::before {
            left: 0;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            padding: var(--space-3) var(--space-6);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition-normal);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
            color: var(--primary);
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .conditional-field {
            transition: all 0.3s ease;
            grid-column: 1 / -1; /* Take full width of the grid */
            width: 100%;
            margin-left: 2rem; /* Indent to show it's conditional */
            border-left: 3px solid #e9ecef;
            padding-left: 1rem;
            background: rgba(0,123,255,0.02);
            border-radius: 8px;
        }

        .conditional-field.hidden {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .app-main {
                padding: 1rem;
            }
            
            .section-fields {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .form-tabs {
                padding: 0;
            }
            
            .tab-button {
                min-width: 120px;
                padding: 0.75rem 1rem;
            }
            
            .multiselect-group {
                grid-template-columns: 1fr;
            }
        }
        
        /* Guide Content Styles */
        .guide-content {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            border: 1px solid #c7d2fe;
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            position: relative;
        }
        
        .guide-content h4 {
            color: var(--primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .guide-content h4:before {
            content: "📘";
            font-size: 1.25rem;
        }
        
        .guide-text {
            color: var(--gray-700);
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .guide-text p {
            margin-bottom: var(--space-3);
        }
        
        .guide-text p:last-child {
            margin-bottom: 0;
        }
        
        .guide-text strong {
            color: var(--gray-900);
            font-weight: 600;
        }
        
        .guide-text ul, .guide-text ol {
            margin: var(--space-3) 0;
            padding-left: var(--space-6);
        }
        
        .guide-text li {
            margin-bottom: var(--space-1);
        }
        
        /* Hide old tooltip elements */
        .tooltip-container,
        .tooltip-trigger {
            display: none;
        }
        
        .form-field label {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-2);
        }
        
        /* Field Help Text Styles */
        .field-help-text {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: var(--radius);
            padding: var(--space-3);
            margin-top: var(--space-2);
            font-size: 0.875rem;
            line-height: 1.5;
            color: var(--gray-700);
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
        }
        
        .help-icon {
            flex-shrink: 0;
            font-size: 1rem;
        }
        
        /* User Guide Document Styles */
        .user-guide-document {
            max-width: 1000px;
            margin: 0 auto;
            padding: var(--space-8);
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            line-height: 1.7;
        }
        
        .guide-header {
            text-align: center;
            margin-bottom: var(--space-12);
            padding-bottom: var(--space-8);
            border-bottom: 3px solid var(--primary);
        }
        
        .guide-header h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: var(--space-4);
            font-weight: 700;
        }
        
        .guide-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            font-weight: 400;
            margin: 0;
        }
        
        .guide-toc {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            margin-bottom: var(--space-10);
        }
        
        .guide-toc h2 {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: var(--space-4);
            font-weight: 600;
        }
        
        .guide-toc ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-2);
        }
        
        .guide-toc li {
            margin: 0;
        }
        
        .toc-link {
            display: block;
            padding: var(--space-3) var(--space-4);
            color: var(--gray-700);
            text-decoration: none;
            border-radius: var(--radius);
            transition: var(--transition-fast);
            font-weight: 500;
        }
        
        .toc-link:hover {
            background: var(--primary-light);
            color: var(--primary);
            transform: translateX(5px);
        }
        
        .guide-section {
            margin-bottom: var(--space-12);
            scroll-margin-top: var(--space-8);
        }
        
        .guide-section h2 {
            color: var(--primary);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-3);
            border-bottom: 2px solid var(--primary-light);
        }
        
        .guide-content-section {
            margin-bottom: var(--space-8);
            background: var(--gray-50);
            border-left: 4px solid var(--primary);
            padding: var(--space-6);
            border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
        }
        
        .guide-content-section h3 {
            color: var(--primary-dark);
            font-size: 1.375rem;
            font-weight: 600;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .guide-content-section h3:before {
            content: "📖";
            font-size: 1.25rem;
        }
        
        .guide-content-section .guide-text {
            color: var(--gray-800);
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .guide-content-section .guide-text p {
            margin-bottom: var(--space-4);
        }
        
        .guide-content-section .guide-text p:last-child {
            margin-bottom: 0;
        }
        
        .guide-content-section .guide-text strong {
            color: var(--gray-900);
            font-weight: 600;
        }
        
        /* Responsive adjustments for guide */
        @media (max-width: 768px) {
            .user-guide-document {
                padding: var(--space-4);
            }
            
            .guide-header h1 {
                font-size: 2rem;
            }
            
            .guide-toc ul {
                grid-template-columns: 1fr;
            }
        }
        
        /* Chatbot Styles */
        .chatbot-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            font-family: inherit;
        }
        
        .chatbot-toggle {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .chatbot-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.6);
        }
        
        .chatbot-panel {
            position: absolute;
            bottom: 75px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--gray-200);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chatbot-panel.open {
            display: flex;
            animation: chatbotSlideIn 0.3s ease-out;
        }
        
        @keyframes chatbotSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .chatbot-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white;
            padding: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .chatbot-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .chatbot-info h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .chatbot-info p {
            margin: 0;
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
            background: #f8fafc;
        }
        
        .chat-message {
            margin-bottom: var(--space-4);
            display: flex;
            gap: var(--space-2);
        }
        
        .chat-message.user {
            flex-direction: row-reverse;
        }
        
        .message-content {
            max-width: 80%;
            padding: var(--space-3);
            border-radius: 12px;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .message-content.bot {
            background: white;
            border: 1px solid var(--gray-200);
            color: var(--gray-800);
        }
        
        .message-content.user {
            background: var(--primary);
            color: white;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .message-avatar.bot {
            background: var(--primary);
            color: white;
        }
        
        .message-avatar.user {
            background: var(--gray-300);
            color: var(--gray-700);
        }
        
        .chatbot-input-area {
            padding: var(--space-4);
            border-top: 1px solid var(--gray-200);
            background: white;
        }
        
        .chatbot-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }
        
        .suggestion-chip {
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            padding: var(--space-2) var(--space-3);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .suggestion-chip:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .chatbot-input {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }
        
        .chatbot-input input {
            flex: 1;
            padding: var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: 20px;
            outline: none;
            font-size: 0.875rem;
        }
        
        .chatbot-input input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .chatbot-send {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }
        
        .chatbot-send:hover {
            background: var(--primary-dark);
        }
        
        .typing-indicator {
            display: none;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--gray-400);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        /* Mobile responsiveness for chatbot */
        @media (max-width: 768px) {
            .chatbot-panel {
                width: calc(100vw - 40px);
                height: 400px;
                right: 10px;
                bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1>🏦 XYZ Custody Forms</h1>
                <nav>
                    <button class="nav-button" onclick="showFormsListPage()" id="nav-forms">
                        <span>📋</span> My Forms
                    </button>
                    <button class="nav-button" onclick="showNewFormPage()" id="nav-new">
                        <span>✨</span> New Form
                    </button>
                </nav>
            </div>
        </header>

        <main class="app-main">
            <!-- Forms List Page -->
            <div id="forms-list-page" class="hidden">
                <div class="header" style="text-align: center; margin-bottom: 3rem;">
                    <h2 style="color: #495057; margin-bottom: 1rem; font-size: 2rem;">Manage Your Forms</h2>
                    <button class="btn-primary" onclick="showNewFormPage()">➕ Create New Form</button>
                </div>

                <!-- Enhanced Search and Filter Controls -->
                <div class="forms-controls" style="background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 8px 30px rgba(0,0,0,0.1);">
                    <div style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 1rem; align-items: center;">
                        <!-- Search Bar -->
                        <div class="search-container" style="position: relative;">
                            <input 
                                type="text" 
                                id="search-input" 
                                placeholder="🔍 Search forms by client name, status, or content..." 
                                style="width: 100%; padding: 0.75rem 1rem 0.75rem 3rem; border: 2px solid #e9ecef; border-radius: 25px; font-size: 1rem; transition: all 0.3s ease;"
                                oninput="handleSearch()"
                                onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 3px rgba(0,123,255,0.1)'"
                                onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'">
                            <div style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: #6c757d;">🔍</div>
                        </div>
                        
                        <!-- Status Filter -->
                        <select id="status-filter" onchange="handleFilter()" style="padding: 0.75rem 1rem; border: 2px solid #e9ecef; border-radius: 8px; background: white; cursor: pointer;">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="completed">Completed</option>
                            <option value="submitted">Submitted</option>
                        </select>
                        
                        <!-- Sort Options -->
                        <select id="sort-options" onchange="handleSort()" style="padding: 0.75rem 1rem; border: 2px solid #e9ecef; border-radius: 8px; background: white; cursor: pointer;">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="name">Client Name A-Z</option>
                            <option value="name-desc">Client Name Z-A</option>
                            <option value="progress">Progress High-Low</option>
                            <option value="progress-low">Progress Low-High</option>
                        </select>
                        
                        <!-- View Toggle -->
                        <div class="view-toggle" style="display: flex; background: #f8f9fa; border-radius: 8px; padding: 0.25rem;">
                            <button id="grid-view" onclick="setViewMode('grid')" class="view-btn active" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; background: #007bff; color: white; font-size: 0.9rem;">📊 Cards</button>
                            <button id="list-view" onclick="setViewMode('list')" class="view-btn" style="padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; background: transparent; color: #6c757d; font-size: 0.9rem;">📋 List</button>
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div id="active-filters" style="margin-top: 1rem; display: none;">
                        <div style="color: #495057; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 600;">Active Filters:</div>
                        <div id="filter-tags" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                    </div>
                    
                    <!-- Results Summary -->
                    <div id="results-summary" style="margin-top: 1rem; color: #6c757d; font-size: 0.9rem; text-align: center;"></div>
                </div>

                <div id="forms-container" class="forms-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading forms...</p>
                    </div>
                </div>
            </div>

            <!-- New Form Page -->
            <div id="new-form-page">
                <div class="form-editor">
                    <div class="editor-header">
                        <h2>Create New XYZ Custody Account Opening Form</h2>
                        <div style="margin-top: 1rem;">
                            <button class="btn-secondary" onclick="showFormsListPage()">← Back to Forms</button>
                        </div>
                    </div>

                    <!-- Form Tabs -->
                    <div class="form-tabs">
                        <button class="tab-button active" onclick="switchTab(0)" id="tab-0">AOF Page 1</button>
                        <button class="tab-button" onclick="switchTab(1)" id="tab-1">AOF Page 2</button>
                        <button class="tab-button" onclick="switchTab(2)" id="tab-2">Additional SWIFTs</button>
                        <button class="tab-button" onclick="switchTab(3); console.log('User Guide tab clicked');" id="tab-3">User Guide</button>
                    </div>

                    <div class="tab-content">
                        <form id="custody-form">
                            <div id="form-content">
                                <!-- Dynamic content will be loaded here -->
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Loading form structure...</p>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-secondary" onclick="resetForm()">🔄 Reset Form</button>
                                <button type="submit" class="btn-primary">💾 Save Form</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Application state
        let currentPage = 'forms-list';
        let currentTab = 0;
        let forms = [];
        let formMetadata = null;

        // Navigation
        function showFormsListPage() {
            console.log('Showing forms list page');
            currentPage = 'forms-list';
            
            const formsListPage = document.getElementById('forms-list-page');
            const newFormPage = document.getElementById('new-form-page');
            const navForms = document.getElementById('nav-forms');
            const navNew = document.getElementById('nav-new');
            
            if (formsListPage) formsListPage.classList.remove('hidden');
            if (newFormPage) newFormPage.classList.add('hidden');
            if (navForms) navForms.classList.add('active');
            if (navNew) navNew.classList.remove('active');
            
            loadForms();
        }

        function showNewFormPage() {
            console.log('Showing new form page');
            currentPage = 'new-form';
            
            const formsListPage = document.getElementById('forms-list-page');
            const newFormPage = document.getElementById('new-form-page');
            const navForms = document.getElementById('nav-forms');
            const navNew = document.getElementById('nav-new');
            
            if (formsListPage) formsListPage.classList.add('hidden');
            if (newFormPage) newFormPage.classList.remove('hidden');
            if (navForms) navForms.classList.remove('active');
            if (navNew) navNew.classList.add('active');
            
            if (!formMetadata) {
                loadFormMetadata();
            } else {
                renderFormContent();
            }
        }

        // Tab switching
        function switchTab(tabIndex) {
            console.log('switchTab called with index:', tabIndex);
            currentTab = tabIndex;
            console.log('currentTab set to:', currentTab);
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach((btn, index) => {
                if (index === tabIndex) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            renderFormContent();
        }

        // Load form metadata
        async function loadFormMetadata() {
            try {
                console.log('Loading form metadata...');
                const response = await fetch('/form-metadata.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                formMetadata = await response.json();
                console.log('Metadata loaded successfully, tabs:', formMetadata.tabs.length);
                renderFormContent();
            } catch (error) {
                console.error('Error loading metadata:', error);
                const container = document.getElementById('form-content');
                if (container) {
                    container.innerHTML = 
                        `<div style="text-align: center; padding: 2rem; color: #dc3545;">
                            <h3>Error loading form structure</h3>
                            <p>Error: ${error.message}</p>
                            <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Reload Page</button>
                        </div>`;
                } else {
                    console.error('form-content element not found');
                }
            }
        }

        // Get tooltip content for a specific field based on User Guide
        function getTooltipContent(fieldName) {
            const tooltipMap = {
                // Section 1: General Account Information
                'bbhAccountNumberReserved': 'Select Yes if you already have a reserved XYZ account number for this account opening.',
                'bbhAccountNumber': 'Enter the 7-digit XYZ account number that was reserved for this account opening.',
                'newAccountNameLegal': 'Account Legal Title is used to identify an account. Can have limit of 228 characters total. Should include client\'s full legal name and full legal names of related parties.',
                'shortAccountName': 'Shortened version displayed in XYZ Infuse and Wire Transfers. 30 character limit. Should be unique and recognizable.',
                'contactName': 'Primary contact person for this account who will receive communications and notifications.',
                'contactEmail': 'Email address for the primary contact person. This will be used for account notifications and communications.',
                'contactPhone': 'Phone number for the primary contact person. Include country and area codes for international numbers.',
                
                // Section 2: Account Services
                'foreignExchangeServices': 'Select if you need Foreign Exchange services with XYZ. This will enable FX trading capabilities for your account.',
                'cashServices': 'Select if you need Cash services. Required for cash-only accounts and accounts handling cash transactions.',
                'physicalServices': 'Select if you need Physical custody services for holding and safekeeping securities.',
                'custodyServices': 'Select if you need Custody services for securities safekeeping, settlement, and administration.',
                
                // Section 3: Global Custody Markets and Cash
                'currencyPreferences': 'Select required currencies for your account. Missing currencies may delay account availability. Choose based on your investment and settlement needs.',
                'marketPreferences': 'Select required markets for custody services. It is important to avoid missing or unnecessary markets as some require more than a business day to open.',
                'euroclearClearstream': 'Select required currencies for International Central Securities Depository (Euroclear/Clearstream) if you trade international fixed income.',
                'clsSetup': 'Select "Yes" if account requires setup in Continuous Linked Settlement foreign exchange settlement system for FX risk mitigation.',
                
                // Section 4: Tax Treatment
                'taxClassification': 'Entity type classification for U.S. tax purposes. Enter your tax classification from IRS Form W-8/W-9 (Individual, Corporation, Trust, Partnership, etc.).',
                'fatcaClassification': 'FATCA classification determines withholding requirements. FFI (Foreign Financial Institution), NFFE (Non-Financial Foreign Entity), or Neither.',
                'taxDomicileCountry': 'Country where account holder is considered tax resident. For U.S. accounts, enter actual state of residence rather than "U.S."',
                'taxpayerIdNumber': 'Local Taxpayer Identification Number. For U.S. citizens living outside U.S., provide U.S. TIN and enter "United States" as domicile.',
                'fatcaWithholding': 'FATCA withholding rate. If not populated, XYZ will determine based on tax documents provided or apply default treatment.',
                
                // Section 5: Foreign Exchange  
                'fxTradingActivity': 'FX trading activity setup can be modeled after existing account. Select execution methods and confirmation preferences.',
                'fxConfirmationMethod': 'Method for FX trade confirmations: SWIFT MT300, Email, or third-party vendor platforms (MISYS, GTSS, FXAll, Bloomberg).',
                'tradingCounterpartyInfo': 'Trading counterparty information cannot be modeled and must be provided manually. Required for XYZ\'s FX regulatory reporting.',
                
                // Mailing and Address fields
                'mailingFormat': 'Delivery methods: SWIFT delivery, Infuse (digital), or Both. Preferred option is Digital Copy via Infuse portal.',
                'infuseUserId': 'Required when Infuse mailing is selected. Your Infuse portal user ID for receiving digital statements and confirmations.',
                'wireTransferSwiftCode': 'SWIFT/BIC code for wire transfers. 8 or 11 characters. Contact name will be populated with account Short Title.',
                'billingAddress': 'Billing information for invoicing purposes. Can use same address as tax documentation mailing or provide different address.',
                
                // SWIFT Message Types
                'mt950Options': 'MT950 Customer Statement options with different aggregation levels (Ledger/Head account aggregated or segregated).',
                'swiftMessages': 'SWIFT message types for trade confirmations: MT513 (intraday execution advice) or MT515 (batch purchase/sale confirmation).',
                'mt535StatementOfPositions': 'MT535 Statement of Positions frequency: Daily, Weekly, Monthly, Daily on activity, Always daily, or Quarterly.',
                
                // Additional common fields
                'primaryAddress': 'Primary mailing address for account correspondence and regulatory communications.',
                'secondaryAddress': 'Secondary address if different from primary address for specific document types.',
                'accountType': 'Account type determined by Services (Cash/Custody) and Markets/Currencies selected. Types: Cash Only, U.S. Custody Only, Global Custody.',
                'additionalServices': 'Additional services beyond basic custody: Corporate Actions, Proxy Services, Tax Relief, Income Processing, etc.'
            };
            
            return tooltipMap[fieldName] || null;
        }

        // Add help text below form fields after rendering
        function addHelpTextToFields() {
            try {
                console.log('addHelpTextToFields called');
                // Find all form fields and add help text below them
                const formFields = document.querySelectorAll('.form-field');
                console.log('Found form fields:', formFields.length);
                
                formFields.forEach(field => {
                    // Get field name from data attribute or input name
                    const input = field.querySelector('input, select, textarea');
                    if (!input) return;
                    
                    const fieldName = input.name || input.id;
                    const helpContent = getTooltipContent(fieldName);
                    
                    if (helpContent) {
                        // Remove existing help text if any
                        const existingHelp = field.querySelector('.field-help-text');
                        if (existingHelp) {
                            existingHelp.remove();
                        }
                        
                        // Create help text element
                        const helpDiv = document.createElement('div');
                        helpDiv.className = 'field-help-text';
                        helpDiv.innerHTML = `
                            <span class="help-icon">💡</span>
                            ${helpContent}
                        `;
                        
                        // Add help text after the input element
                        input.parentNode.appendChild(helpDiv);
                        console.log('Added help text for field:', fieldName);
                    }
                });
            } catch (error) {
                console.error('Error in addHelpTextToFields:', error);
            }
        }

        // Render form content based on current tab
        function renderFormContent() {
            console.log('renderFormContent called, currentTab:', currentTab);
            if (!formMetadata) {
                console.log('No formMetadata available');
                return;
            }
            
            // Debug: show all tab names
            console.log('All tabs:', formMetadata.tabs.map((tab, i) => `${i}: ${tab.name}`));
            
            const container = document.getElementById('form-content');
            const currentTabData = formMetadata.tabs[currentTab];
            console.log('currentTabData:', currentTabData);
            
            if (!currentTabData || !currentTabData.sections) {
                console.log('No currentTabData or sections');
                container.innerHTML = '<div style="text-align: center; padding: 2rem;">No content available for this tab</div>';
                return;
            }
            
            // Special handling for User Guide tab
            if (currentTabData.name === 'User Guide' || currentTabData.name.includes('Guide') || currentTab === 3) {
                console.log('Rendering User Guide tab:', currentTabData);
                renderUserGuide(currentTabData, container);
                return;
            }
            console.log('Rendering regular tab:', currentTabData.name);
            
            let html = '<div class="form-sections">';
            
            currentTabData.sections.forEach(section => {
                html += `
                    <div class="form-section">
                        <h3 class="section-title">
                            <span class="section-number">${section.number}</span>
                            ${section.title}
                        </h3>
                        <div class="section-fields">
                `;
                
                section.fields.forEach(field => {
                    html += renderField(field);
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Setup conditional logic after rendering
            try {
                setupConditionalLogic();
                console.log('setupConditionalLogic completed successfully');
            } catch (error) {
                console.error('Error in setupConditionalLogic:', error);
            }
            
            // Add help text below form fields
            setTimeout(() => {
                try {
                    addHelpTextToFields();
                } catch (error) {
                    console.error('Error calling addHelpTextToFields:', error);
                }
            }, 100);
        }

        // Render User Guide as a document instead of form fields
        function renderUserGuide(guideData, container) {
            console.log('renderUserGuide called with:', guideData);
            
            // Create a proper User Guide since the Excel data is corrupted
            const properUserGuide = {
                sections: [
                    {
                        title: "📋 Introduction",
                        content: "The purpose of this guide is to assist clients in the completion of the XYZ Custody Account Opening Form. This form should be completed and sent to your client service team along with an instruction to open the account. It is recommended the form be password protected, with the password sent in a separate email."
                    },
                    {
                        title: "⚡ How the Form Works",
                        content: "This form uses conditional logic - initial selections will trigger next available fields or sub-sections to appear for input. Please ensure to input information in all available sections to complete the setup. All mandatory fields are marked in yellow or with a red marker. Use your mouse to click and navigate rather than using the ENTER button."
                    },
                    {
                        title: "🏢 1. General Account Information",
                        content: "<strong>New Account Name (Long Name - Legal Title):</strong> Account Legal Title is used to identify an account. Can have limit of 228 characters total. Should include client's full legal name.<br><br><strong>Short New Account Name:</strong> Shortened version displayed in XYZ Infuse and Wire Transfers. 30 character limit. Should be unique and recognizable.<br><br><strong>Contact Information:</strong> Primary contact person for this account who will receive communications and notifications."
                    },
                    {
                        title: "⚙️ 2. Account Services",
                        content: "Select all services which need to be added to the new account. The account type will be defined based on your selections of Services (Cash and/or Custody) and Markets/Currencies in Section 3.<br><br><strong>Available Account Types:</strong><br>• Cash Only Account<br>• U.S. Custody Only Account<br>• Global Custody Account<br><br>Services selected should match the services contracted with XYZ."
                    },
                    {
                        title: "🌍 3. Global Custody Markets and Cash",
                        content: "Select the required markets and currencies for your account. It is important to avoid any missing or unnecessary markets or currencies. Missing markets may incur a delay in availability of the account.<br><br><strong>Key Considerations:</strong><br>• Non-Registration Markets: Select required markets and currencies<br>• Registration Markets: Refer to Registration Kits within XYZ Infuse<br>• Euroclear/Clearstream: Select required currencies for ICSD<br>• CLS: Select if account requires Continuous Linked Settlement setup"
                    },
                    {
                        title: "💰 4. Intended Tax Treatment",
                        content: "<strong>Cash Only Accounts:</strong> Require Taxpayer Identification section to be populated with Taxpayer Title, Local Taxpayer ID Number, and Address.<br><br><strong>Important Notes:</strong><br>• For U.S. accounts, enter actual state of residence rather than 'U.S.'<br>• For U.S. citizens living outside U.S., enter 'United States'<br>• Enter tax classification from IRS Form W-8/W-9<br>• FATCA withholding may apply if proper documentation not provided<br><br><strong>Custody Accounts:</strong> First question identifies account structure (Direct vs. Intermediary)."
                    },
                    {
                        title: "💱 5. Foreign Exchange with XYZ",
                        content: "This section appears when Foreign Exchange service is selected in Section 2.<br><br><strong>FX Trading Activity:</strong> Can be modeled after existing account<br><strong>Trading Counterparty Info:</strong> Cannot be modeled, details must be provided manually<br><br><strong>Execution Methods:</strong><br>• Negotiated FX Execution - Active Execution<br>• Non-Negotiated Execution<br><br><strong>Confirmation Methods:</strong><br>• SWIFT MT300<br>• Email<br>• Third-party vendor platforms (MISYS, GTSS, FXAll, Bloomberg)"
                    },
                    {
                        title: "💳 6. Cash Posting Transactions",
                        content: "Select these options if any cash or custody flows should be posted from the head account to another XYZ account number. This section can be modeled after existing accounts. Required for U.S. Custody Only Accounts as USD cash transform for all transactions is required."
                    },
                    {
                        title: "📮 7. Mailing Products",
                        content: "Delivery methods supported include paper statements, SWIFT delivery, email, and Infuse. The delivery methods available vary by mailing product.<br><br><strong>Cash Service Mailing:</strong> Preferred option is Digital Copy via Infuse portal<br><strong>Custody Service Mailing:</strong> Preferred option is Digital Copy via Infuse portal - Statements Online<br><br>Contact your client service team to discuss any custom delivery methods."
                    },
                    {
                        title: "🏦 8. Wire Transfer Address",
                        content: "Wire transfer address is required for electronic transfer of funds. The contact name will be populated with the Short Title of the account. Address should not include PO Box or words 'Personal' or 'Confidential'. Option to use same address as tax documentation mailing from Section 4."
                    },
                    {
                        title: "🧾 9. Billing Address",
                        content: "Please input billing information for invoicing purposes. Option to use same address as tax documentation mailing from Section 4, or provide different address when 'Other' is selected."
                    },
                    {
                        title: "💰 10. Cash Accounting",
                        content: "XYZ's Contractual Cash Program for USD is a settlement valuation option for funds management. Gives 'as of' contractual value on 'vs. payment' security settlements. Allows clients to commit to security sale proceeds prior to settlement while avoiding overdraft charges. For more information, see Custody Client Guide in Infuse."
                    },
                    {
                        title: "📈 11. Trades - Custody",
                        content: "This section is visible only if Custody service is selected in Section 2.<br><br><strong>11.1 Trades Authorization:</strong> BIC addresses (8 or 11 characters) authorized for payments or trades. Authorized Persons Document required.<br><br><strong>11.2 Custody Security Instructions:</strong><br>• Client Duplicate Check options<br>• Depository Movement Service<br>• DNR Money tolerance<br>• Holiday Service<br>• Fed 50 million<br>• Return Delivery Service (RTD)<br><br><strong>11.3 SWIFTs for Trades & Position Reporting:</strong> SWIFT/BIC addresses for delivery<br><br><strong>11.4 Shareholder Rights Directive II:</strong> Account classification for SRDII compliance"
                    },
                    {
                        title: "💸 12. Payments - Cash",
                        content: "<strong>12.1 Payments Authorization:</strong> BIC addresses (8 or 11 characters) authorized for payments or trades. XYZ Infuse portal provides ability to execute and authorize payments.<br><br><strong>12.2 SWIFTs for Cash:</strong> SWIFT/BIC addresses for cash-related SWIFT delivery. Complete Additional SWIFT section if multiple BIC addresses with different requirements needed."
                    },
                    {
                        title: "📊 13. FWDP - Allow MT304 Forward Processing",
                        content: "BIC addresses (8 or 11 characters) authorized for MT304 forward processing. XYZ will require Authorized Persons Document. Indicate if any BIC addresses are for third parties (e.g., subadvisor)."
                    },
                    {
                        title: "🏢 14. Corporate Actions",
                        content: "Comprehensive corporate actions services including:<br><br><strong>14.1 Contacts Information:</strong> Primary, Escalation and Fax back contacts required<br><strong>14.2 Notification Receipt Methods:</strong> ActionView®, SWIFT, or fax<br><strong>14.3 Notification Products:</strong> Eligibility Date Notices for various action types<br><strong>14.4-14.18 Additional Services:</strong><br>• Odd Lot Tenders Processing<br>• Response Standing Instructions<br>• Cash Dividends Service<br>• Currency Options Service<br>• Restricted Security Exchange Offers<br>• Certifications Standing Instructions<br>• Response Reconciliation Report<br>• Pre-payment Advice<br>• MT566 Payment Confirmation<br>• Provisional Income Program<br>• Income Reclassification Service<br>• Proxy Information"
                    },
                    {
                        title: "📈 15. Fund Order & Custody",
                        content: "<strong>15.1 Fund Order & Custody Information:</strong> Fund order and custody services setup<br><br><strong>15.2 Prospectus:</strong> Address for Mutual Fund Prospectus mailing. Email address required if suppressing hard copy.<br><br><strong>15.3 Service Mailing Products:</strong> MFPS Confirmation delivery methods:<br>• Hard copy mailing (up to 3 addresses)<br>• Email<br>• SWIFT (MT515)<br><br>For Fund Order & Custody services, select required currencies for settlement of Fund Orders."
                    },
                    {
                        title: "❓ Additional Help",
                        content: "<strong>For additional assistance:</strong><br>• Hover over the ℹ️ icon next to field labels for specific guidance<br>• Contact your Client Service Representative for complex requirements<br>• Review detailed documentation in XYZ Infuse<br>• Use mouse to navigate rather than ENTER button<br><br><strong>Contact:</strong> If you have questions about this guide or process, contact your client service team."
                    }
                ]
            };
            
            try {
                let html = `
                    <div class="user-guide-document">
                        <div class="guide-header">
                            <h1>📚 XYZ Custody Account Opening Form - User Guide</h1>
                            <p class="guide-subtitle">Complete guidance for filling out your account opening form</p>
                        </div>
                        
                        <div class="guide-toc">
                            <h2>📋 Table of Contents</h2>
                            <ul>
                `;
                
                // Generate table of contents
                properUserGuide.sections.forEach((section, index) => {
                    html += `<li><a href="#guide-section-${index}" class="toc-link">${section.title}</a></li>`;
                });
                
                html += `
                            </ul>
                        </div>
                `;
                
                // Generate all sections
                properUserGuide.sections.forEach((section, index) => {
                    html += `
                        <div class="guide-section" id="guide-section-${index}">
                            <h2>${section.title}</h2>
                            <div class="guide-content-section">
                                <div class="guide-text">
                                    <p>${section.content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                console.log('Generated proper User Guide HTML length:', html.length);
                container.innerHTML = html;
                setupGuideNavigation();
                
            } catch (error) {
                console.error('Error rendering User Guide:', error);
                container.innerHTML = `<div style="padding: 2rem; color: red;">Error rendering User Guide: ${error.message}</div>`;
            }
        }

        // Setup guide navigation
        function setupGuideNavigation() {
            document.querySelectorAll('.toc-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        }

        // Render individual field
        function renderField(field) {
            const conditionalClass = field.conditional ? 'conditional-field' : '';
            const conditionalId = field.conditional ? `conditional-${field.name}` : '';
            
            let fieldHtml = `<div class="form-field ${conditionalClass}" id="${conditionalId}" data-field="${field.name}">`;
            
            switch (field.type) {
                case 'text':
                case 'email':
                case 'tel':
                    fieldHtml += `
                        <label for="${field.name}">
                            ${field.label}${field.required ? ' *' : ''}

                        </label>
                        <input 
                            type="${field.type}" 
                            id="${field.name}" 
                            name="${field.name}"
                            ${field.required ? 'required' : ''}
                            ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}
                            ${field.pattern ? `pattern="${field.pattern}"` : ''}
                            placeholder="${field.helpText || ''}"
                            onchange="handleFieldChange('${field.name}')">
                    `;
                    break;
                    
                case 'textarea':
                    fieldHtml += `
                        <label for="${field.name}">
                            ${field.label}${field.required ? ' *' : ''}

                        </label>
                        <textarea 
                            id="${field.name}" 
                            name="${field.name}"
                            ${field.required ? 'required' : ''}
                            ${field.maxLength ? `maxlength="${field.maxLength}"` : ''}
                            placeholder="${field.helpText || ''}"
                            onchange="handleFieldChange('${field.name}')"></textarea>
                    `;
                    break;
                    
                case 'radio':
                    fieldHtml += `
                        <label class="field-label">
                            ${field.label}${field.required ? ' *' : ''}

                        </label>
                        <div class="radio-group">
                    `;
                    field.options.forEach(option => {
                        fieldHtml += `
                            <div class="radio-option">
                                <input 
                                    type="radio" 
                                    id="${field.name}_${option}" 
                                    name="${field.name}" 
                                    value="${option}"
                                    onchange="handleFieldChange('${field.name}')">
                                <label for="${field.name}_${option}">${option}</label>
                            </div>
                        `;
                    });
                    fieldHtml += '</div>';
                    break;
                    
                case 'guide-content':
                    fieldHtml += `
                        <div class="guide-content">
                            <h4>${field.label}</h4>
                            <div class="guide-text">${field.content}</div>
                        </div>
                    `;
                    break;
                    
                case 'checkbox':
                    fieldHtml += `
                        <div class="checkbox-option">
                            <input 
                                type="checkbox" 
                                id="${field.name}" 
                                name="${field.name}"
                                onchange="handleFieldChange('${field.name}')">
                            <label for="${field.name}">
                                ${field.label}

                            </label>
                        </div>
                    `;
                    break;
                    
                case 'checkbox-with-options':
                    fieldHtml += `
                        <div class="checkbox-option">
                            <input 
                                type="checkbox" 
                                id="${field.name}" 
                                name="${field.name}"
                                onchange="handleFieldChange('${field.name}')">
                            <label for="${field.name}">
                                ${field.label}

                            </label>
                        </div>
                    `;
                    if (field.conditionalOptions && field.conditionalOptions.length > 0) {
                        fieldHtml += `
                            <div class="conditional-options" id="conditional-${field.name}" style="display: none; margin-top: 1rem; margin-left: 2rem;">
                                <div class="help-text" style="margin-bottom: 0.5rem;">${field.helpText || 'Please select frequency:'}</div>
                                <div class="checkbox-group">
                        `;
                        field.conditionalOptions.forEach(option => {
                            fieldHtml += `
                                <div class="checkbox-option">
                                    <input 
                                        type="checkbox" 
                                        id="${field.name}_${option}" 
                                        name="${field.name}_options" 
                                        value="${option}"
                                        onchange="handleFieldChange('${field.name}')">
                                    <label for="${field.name}_${option}">${option}</label>
                                </div>
                            `;
                        });
                        fieldHtml += `
                                </div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'dropdown':
                    fieldHtml += `
                        <label for="${field.name}">
                            ${field.label}${field.required ? ' *' : ''}

                        </label>
                        <select 
                            id="${field.name}" 
                            name="${field.name}"
                            ${field.required ? 'required' : ''}
                            onchange="handleFieldChange('${field.name}')">
                            <option value="">Select an option...</option>
                    `;
                    field.options.forEach(option => {
                        fieldHtml += `<option value="${option}">${option}</option>`;
                    });
                    fieldHtml += '</select>';
                    break;
                    
                case 'multiselect':
                    fieldHtml += `
                        <label class="field-label">
                            ${field.label}${field.required ? ' *' : ''}

                        </label>
                        <div class="multiselect-group">
                    `;
                    field.options.forEach(option => {
                        fieldHtml += `
                            <div class="multiselect-option">
                                <input 
                                    type="checkbox" 
                                    id="${field.name}_${option}" 
                                    name="${field.name}" 
                                    value="${option}"
                                    onchange="handleMultiselectChange('${field.name}')">
                                <label for="${field.name}_${option}">${option}</label>
                            </div>
                        `;
                    });
                    fieldHtml += '</div>';
                    break;
                    
                case 'checkbox-group':
                    fieldHtml += `
                        <label class="field-label">
                            ${field.label}${field.required ? ' *' : ''}

                        </label>
                        <div class="checkbox-group">
                    `;
                    if (field.options) {
                        field.options.forEach(option => {
                            fieldHtml += `
                                <div class="checkbox-option">
                                    <input 
                                        type="checkbox" 
                                        id="${field.name}_${option}" 
                                        name="${field.name}" 
                                        value="${option}"
                                        onchange="handleFieldChange('${field.name}')">
                                    <label for="${field.name}_${option}">${option}</label>
                                </div>
                            `;
                        });
                    }
                    fieldHtml += '</div>';
                    break;
                    
                default:
                    fieldHtml += `
                        <label for="${field.name}">${field.label}${field.required ? ' *' : ''}</label>
                        <input 
                            type="text" 
                            id="${field.name}" 
                            name="${field.name}"
                            ${field.required ? 'required' : ''}
                            onchange="handleFieldChange('${field.name}')">
                    `;
            }
            
            if (field.helpText) {
                fieldHtml += `<div class="help-text">${field.helpText}</div>`;
            }
            
            fieldHtml += '</div>';
            return fieldHtml;
        }

        // Handle field changes and conditional logic
        function handleFieldChange(fieldName) {
            console.log('Field changed:', fieldName);
            
            // Handle checkbox-with-options type
            const checkbox = document.getElementById(fieldName);
            const conditionalOptions = document.getElementById(`conditional-${fieldName}`);
            
            if (checkbox && conditionalOptions) {
                if (checkbox.checked) {
                    conditionalOptions.style.display = 'block';
                } else {
                    conditionalOptions.style.display = 'none';
                }
            }
            
            updateConditionalFields();
        }

        function handleMultiselectChange(fieldName) {
            console.log('Multiselect changed:', fieldName);
            updateConditionalFields();
        }

        // Setup and update conditional logic
        function setupConditionalLogic() {
            updateConditionalFields();
        }

        function updateConditionalFields() {
            if (!formMetadata) return;
            
            const currentTabData = formMetadata.tabs[currentTab];
            if (!currentTabData || !currentTabData.sections) return;
            
            currentTabData.sections.forEach(section => {
                section.fields.forEach(field => {
                    if (field.conditional) {
                        const shouldShow = evaluateConditional(field.conditional);
                        const fieldElement = document.getElementById(`conditional-${field.name}`);
                        
                        if (fieldElement) {
                            if (shouldShow) {
                                fieldElement.classList.remove('hidden');
                            } else {
                                fieldElement.classList.add('hidden');
                            }
                        }
                    }
                });
            });
        }

        function evaluateConditional(conditional) {
            const triggerField = document.querySelector(`[name="${conditional.field}"]`);
            if (!triggerField) return false;
            
            let fieldValue;
            if (triggerField.type === 'checkbox') {
                fieldValue = triggerField.checked;
            } else if (triggerField.type === 'radio') {
                const checkedRadio = document.querySelector(`[name="${conditional.field}"]:checked`);
                fieldValue = checkedRadio ? checkedRadio.value : null;
            } else {
                fieldValue = triggerField.value;
            }
            
            switch (conditional.operator) {
                case 'equals':
                    return conditional.showWhen ? fieldValue === conditional.value : fieldValue !== conditional.value;
                case 'in':
                    const isInArray = Array.isArray(conditional.value) && conditional.value.includes(fieldValue);
                    return conditional.showWhen ? isInArray : !isInArray;
                case 'not_equals':
                    return conditional.showWhen ? fieldValue !== conditional.value : fieldValue === conditional.value;
                default:
                    return true;
            }
        }

        // Form submission and management
        function resetForm() {
            if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                document.getElementById('custody-form').reset();
                updateConditionalFields();
            }
        }

        // API functions for forms list
        async function loadForms() {
            try {
                console.log('Loading forms...');
                const response = await fetch('/api/forms');
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                forms = await response.json();
                console.log('Loaded forms:', forms);
                renderForms();
            } catch (error) {
                console.error('Error loading forms:', error);
                document.getElementById('forms-container').innerHTML = 
                    `<div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <h3>Error loading forms</h3>
                        <p>${error.message}</p>
                        <button class="btn-primary" onclick="loadForms()">Retry</button>
                    </div>`;
            }
        }

        // Enhanced forms management with search, filter, and view modes
        let filteredForms = [];
        let currentViewMode = 'grid';
        
        function renderForms(formsToRender = forms) {
            console.log('Rendering forms, count:', formsToRender?.length || 0);
            const container = document.getElementById('forms-container');
            filteredForms = formsToRender || [];
            
            // Update results summary
            updateResultsSummary(filteredForms.length, forms?.length || 0);
            
            if (!filteredForms || filteredForms.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 4rem; background: white; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1);">
                        <div style="font-size: 4rem; margin-bottom: 2rem;">📋</div>
                        <h3 style="color: #495057; margin-bottom: 1rem;">${forms?.length > 0 ? 'No forms match your search' : 'No Forms Yet'}</h3>
                        <p style="color: #6c757d; margin-bottom: 2rem;">${forms?.length > 0 ? 'Try adjusting your search or filters.' : 'Create your first XYZ Custody Account Opening Form to get started.'}</p>
                        ${forms?.length > 0 ? '<button class="btn-secondary" onclick="clearAllFilters()">Clear Filters</button>' : '<button class="btn-primary" onclick="showNewFormPage()">Create New Form</button>'}
                    </div>
                `;
                return;
            }

            // Update container class based on view mode
            container.className = currentViewMode === 'grid' ? 'forms-grid' : 'forms-list';
            
            if (currentViewMode === 'grid') {
                container.innerHTML = filteredForms.map(form => renderFormCard(form)).join('');
            } else {
                container.innerHTML = filteredForms.map(form => renderFormListItem(form)).join('');
            }
        }
        
        function renderFormCard(form) {
            const completionPercentage = calculateCompletionPercentage(form);
            const formDataPreview = getFormDataPreview(form);
            
            return `
                <div class="form-card" style="position: relative; overflow: hidden;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: #495057; font-size: 1.3rem;">${form.clientName}</h3>
                            <div style="font-size: 0.85rem; color: #6c757d;">${form.id.substring(0, 8)}...</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${getStatusBadge(form.status)}
                            <div class="form-menu" style="position: relative;">
                                <button onclick="toggleFormMenu('${form.id}')" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.25rem;">⋮</button>
                                <div id="menu-${form.id}" class="form-menu-dropdown" style="display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 100; min-width: 150px;">
                                    <button onclick="viewFormDetails('${form.id}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa;">👁️ View Details</button>
                                    <button onclick="editForm('${form.id}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa;">✏️ Edit</button>
                                    <button onclick="duplicateForm('${form.id}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa;">📋 Duplicate</button>
                                    <button onclick="downloadForm('${form.id}', '${form.clientName}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f8f9fa;">💾 Export</button>
                                    <button onclick="deleteForm('${form.id}', '${form.clientName}')" style="width: 100%; padding: 0.75rem 1rem; border: none; background: none; text-align: left; cursor: pointer; font-size: 0.9rem; color: #dc3545;">🗑️ Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Data Preview -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: #495057; margin-bottom: 0.5rem;">Form Preview:</div>
                        <div style="font-size: 0.8rem; color: #6c757d; line-height: 1.4;">
                            ${formDataPreview}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem; color: #6c757d; font-size: 0.9rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <span style="font-weight: 600;">Created:</span><br>
                                <span>${formatDate(form.createdDate)}</span>
                            </div>
                            <div>
                                <span style="font-weight: 600;">Modified:</span><br>
                                <span>${formatDate(form.lastModified)}</span>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Progress:</span>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 100px; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 100%; background: linear-gradient(90deg, ${getProgressColor(completionPercentage)}); width: ${completionPercentage}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-size: 0.9rem; font-weight: 600;">${completionPercentage}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="viewFormDetails('${form.id}')" style="padding: 0.5rem 1rem; font-size: 0.85rem; flex: 1;">👁️ View</button>
                        <button class="btn-secondary" onclick="downloadForm('${form.id}', '${form.clientName}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">💾</button>
                        <button onclick="deleteForm('${form.id}', '${form.clientName}')" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">🗑</button>
                    </div>
                </div>
            `;
        }
        
        function renderFormListItem(form) {
            const completionPercentage = calculateCompletionPercentage(form);
            const formDataPreview = getFormDataPreview(form);
            
            return `
                <div class="form-list-item" style="background: white; border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: grid; grid-template-columns: 2fr 1fr 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #495057;">${form.clientName}</h4>
                        <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 0.5rem;">${form.id.substring(0, 8)}...</div>
                        <div style="font-size: 0.75rem; color: #868e96;">${formDataPreview}</div>
                    </div>
                    <div style="text-align: center;">
                        ${getStatusBadge(form.status)}
                    </div>
                    <div style="text-align: center; font-size: 0.85rem; color: #6c757d;">
                        <div style="font-weight: 600;">Created</div>
                        <div>${formatDate(form.createdDate)}</div>
                        <div style="margin-top: 0.5rem; font-weight: 600;">Modified</div>
                        <div>${formatDate(form.lastModified)}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; background: conic-gradient(${getProgressColor(completionPercentage)} ${completionPercentage * 3.6}deg, #e9ecef 0deg); display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            <div style="width: 45px; height: 45px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600;">${completionPercentage}%</div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <button class="btn-secondary" onclick="viewFormDetails('${form.id}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">👁️ View</button>
                        <button class="btn-secondary" onclick="downloadForm('${form.id}', '${form.clientName}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">💾 Export</button>
                        <button onclick="deleteForm('${form.id}', '${form.clientName}')" style="padding: 0.4rem 0.8rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">🗑 Delete</button>
                    </div>
                </div>
            `;
        }

        // Helper functions for enhanced UI
        function calculateCompletionPercentage(form) {
            if (!form.formData || typeof form.formData !== 'object') return 0;
            
            let totalFields = 0;
            let completedFields = 0;
            
            Object.values(form.formData).forEach(section => {
                if (typeof section === 'object' && section !== null) {
                    Object.entries(section).forEach(([key, value]) => {
                        totalFields++;
                        if (value && value !== '' && value !== false) {
                            completedFields++;
                        }
                    });
                }
            });
            
            return totalFields === 0 ? 0 : Math.round((completedFields / totalFields) * 100);
        }
        
        function getFormDataPreview(form) {
            if (!form.formData) return 'No data available';
            
            const previews = [];
            Object.values(form.formData).forEach(section => {
                if (typeof section === 'object' && section !== null) {
                    Object.entries(section).forEach(([key, value]) => {
                        if (value && value !== '' && value !== false) {
                            const cleanKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                            const cleanValue = typeof value === 'boolean' ? (value ? 'Yes' : 'No') : String(value).substring(0, 30);
                            previews.push(`${cleanKey}: ${cleanValue}`);
                        }
                    });
                }
            });
            
            return previews.length > 0 ? previews.slice(0, 3).join(' • ') + (previews.length > 3 ? '...' : '') : 'No data available';
        }
        
        function getStatusBadge(status) {
            const statusConfig = {
                'draft': { bg: '#fff3cd', color: '#856404', icon: '📝' },
                'completed': { bg: '#d4edda', color: '#155724', icon: '✅' },
                'submitted': { bg: '#d1ecf1', color: '#0c5460', icon: '📤' }
            };
            
            const config = statusConfig[status] || statusConfig['draft'];
            return `<div style="padding: 0.4rem 0.8rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; background-color: ${config.bg}; color: ${config.color}; display: flex; align-items: center; gap: 0.25rem;">
                ${config.icon} ${status.charAt(0).toUpperCase() + status.slice(1)}
            </div>`;
        }
        
        function getProgressColor(percentage) {
            if (percentage < 25) return '#dc3545, #dc3545';
            if (percentage < 50) return '#fd7e14, #ffc107';
            if (percentage < 75) return '#ffc107, #28a745';
            return '#28a745, #007bff';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
            
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        // Search and Filter Functions
        function handleSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            applyFilters();
        }
        
        function handleFilter() {
            applyFilters();
        }
        
        function handleSort() {
            applyFilters();
        }
        
        function applyFilters() {
            if (!forms) return;
            
            let filtered = [...forms];
            
            // Apply search filter
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(form => {
                    const clientName = form.clientName.toLowerCase();
                    const status = form.status.toLowerCase();
                    const formDataText = getFormDataPreview(form).toLowerCase();
                    const id = form.id.toLowerCase();
                    
                    return clientName.includes(searchTerm) || 
                           status.includes(searchTerm) || 
                           formDataText.includes(searchTerm) ||
                           id.includes(searchTerm);
                });
            }
            
            // Apply status filter
            const statusFilter = document.getElementById('status-filter').value;
            if (statusFilter) {
                filtered = filtered.filter(form => form.status === statusFilter);
            }
            
            // Apply sorting
            const sortOption = document.getElementById('sort-options').value;
            filtered.sort((a, b) => {
                switch (sortOption) {
                    case 'newest':
                        return new Date(b.createdDate) - new Date(a.createdDate);
                    case 'oldest':
                        return new Date(a.createdDate) - new Date(b.createdDate);
                    case 'name':
                        return a.clientName.localeCompare(b.clientName);
                    case 'name-desc':
                        return b.clientName.localeCompare(a.clientName);
                    case 'progress':
                        return calculateCompletionPercentage(b) - calculateCompletionPercentage(a);
                    case 'progress-low':
                        return calculateCompletionPercentage(a) - calculateCompletionPercentage(b);
                    default:
                        return 0;
                }
            });
            
            updateActiveFilters(searchTerm, statusFilter);
            renderForms(filtered);
        }
        
        function updateActiveFilters(searchTerm, statusFilter) {
            const activeFiltersContainer = document.getElementById('active-filters');
            const filterTagsContainer = document.getElementById('filter-tags');
            
            const activeTags = [];
            if (searchTerm) activeTags.push(`Search: "${searchTerm}"`);
            if (statusFilter) activeTags.push(`Status: ${statusFilter}`);
            
            if (activeTags.length > 0) {
                activeFiltersContainer.style.display = 'block';
                filterTagsContainer.innerHTML = activeTags.map(tag => 
                    `<span style="background: #e9ecef; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; color: #495057;">
                        ${tag} <button onclick="clearFilter('${tag.split(':')[0].toLowerCase()}')" style="background: none; border: none; margin-left: 0.5rem; cursor: pointer; color: #6c757d;">×</button>
                    </span>`
                ).join('');
            } else {
                activeFiltersContainer.style.display = 'none';
            }
        }
        
        function clearFilter(type) {
            if (type === 'search') {
                document.getElementById('search-input').value = '';
            } else if (type === 'status') {
                document.getElementById('status-filter').value = '';
            }
            applyFilters();
        }
        
        function clearAllFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('sort-options').value = 'newest';
            applyFilters();
        }
        
        function updateResultsSummary(filteredCount, totalCount) {
            const summary = document.getElementById('results-summary');
            if (filteredCount === totalCount) {
                summary.innerHTML = `Showing ${totalCount} form${totalCount !== 1 ? 's' : ''}`;
            } else {
                summary.innerHTML = `Showing ${filteredCount} of ${totalCount} form${totalCount !== 1 ? 's' : ''}`;
            }
        }
        
        // View Mode Functions
        function setViewMode(mode) {
            currentViewMode = mode;
            
            // Update button states
            document.getElementById('grid-view').className = mode === 'grid' ? 'view-btn active' : 'view-btn';
            document.getElementById('list-view').className = mode === 'list' ? 'view-btn active' : 'view-btn';
            
            // Update button styles
            if (mode === 'grid') {
                document.getElementById('grid-view').style.background = '#007bff';
                document.getElementById('grid-view').style.color = 'white';
                document.getElementById('list-view').style.background = 'transparent';
                document.getElementById('list-view').style.color = '#6c757d';
            } else {
                document.getElementById('list-view').style.background = '#007bff';
                document.getElementById('list-view').style.color = 'white';
                document.getElementById('grid-view').style.background = 'transparent';
                document.getElementById('grid-view').style.color = '#6c757d';
            }
            
            renderForms(filteredForms);
        }
        
        // Form Actions
        function toggleFormMenu(formId) {
            const menu = document.getElementById(`menu-${formId}`);
            const isVisible = menu.style.display !== 'none';
            
            // Close all other menus
            document.querySelectorAll('.form-menu-dropdown').forEach(m => m.style.display = 'none');
            
            menu.style.display = isVisible ? 'none' : 'block';
            
            // Close menu when clicking outside
            if (!isVisible) {
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!e.target.closest('.form-menu')) {
                            menu.style.display = 'none';
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 100);
            }
        }
        
        function viewFormDetails(formId) {
            const form = forms.find(f => f.id === formId);
            if (!form) return;
            
            // Create and show detailed view modal
            showFormDetailsModal(form);
        }
        
        function showFormDetailsModal(form) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); 
                display: flex; align-items: center; justify-content: center; z-index: 1000;
            `;
            
            const completionPercentage = calculateCompletionPercentage(form);
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #f8f9fa; padding-bottom: 1rem;">
                        <h2 style="margin: 0; color: #495057;">Form Details</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">×</button>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #495057;">${form.clientName}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div><strong>Form ID:</strong> ${form.id}</div>
                            <div><strong>Status:</strong> ${getStatusBadge(form.status)}</div>
                            <div><strong>Created:</strong> ${formatDate(form.createdDate)}</div>
                            <div><strong>Last Modified:</strong> ${formatDate(form.lastModified)}</div>
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <strong>Completion Progress:</strong>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem;">
                                <div style="flex: 1; height: 12px; background: #e9ecef; border-radius: 6px; overflow: hidden;">
                                    <div style="height: 100%; background: linear-gradient(90deg, ${getProgressColor(completionPercentage)}); width: ${completionPercentage}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-weight: 600; min-width: 50px;">${completionPercentage}%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #495057;">Form Data Summary:</h4>
                        <div style="font-size: 0.9rem; color: #6c757d; line-height: 1.6;">
                            ${getDetailedFormPreview(form)}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                        <button onclick="downloadForm('${form.id}', '${form.clientName}')" class="btn-secondary">💾 Export</button>
                        <button onclick="editForm('${form.id}')" class="btn-primary">✏️ Edit Form</button>
                        <button onclick="this.closest('.modal').remove()" class="btn-secondary">Close</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function getDetailedFormPreview(form) {
            if (!form.formData) return 'No form data available.';
            
            const sections = [];
            Object.entries(form.formData).forEach(([sectionKey, section]) => {
                if (typeof section === 'object' && section !== null) {
                    const fields = [];
                    Object.entries(section).forEach(([key, value]) => {
                        if (value && value !== '' && value !== false) {
                            const cleanKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                            const cleanValue = typeof value === 'boolean' ? (value ? 'Yes' : 'No') : String(value);
                            fields.push(`<strong>${cleanKey}:</strong> ${cleanValue}`);
                        }
                    });
                    
                    if (fields.length > 0) {
                        sections.push(`<div style="margin-bottom: 1rem;"><div style="font-weight: 600; color: #495057; margin-bottom: 0.5rem; text-transform: capitalize;">${sectionKey.replace(/([A-Z])/g, ' $1')}</div>${fields.join('<br>')}</div>`);
                    }
                }
            });
            
            return sections.length > 0 ? sections.join('') : 'No completed fields yet.';
        }
        
        function editForm(formId) {
            // Implement edit functionality
            console.log('Edit form:', formId);
            alert('Edit functionality would be implemented here');
        }
        
        function duplicateForm(formId) {
            // Implement duplicate functionality
            console.log('Duplicate form:', formId);
            alert('Duplicate functionality would be implemented here');
        }

        async function downloadForm(id, clientName) {
            try {
                const response = await fetch(`/api/forms/${id}/export`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `xyz-custody-form-${clientName.replace(/[^a-zA-Z0-9]/g, '_')}-${id.substring(0, 8)}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading form:', error);
                alert('Error downloading form');
            }
        }

        async function deleteForm(id, clientName) {
            if (!confirm(`Are you sure you want to delete the form for "${clientName}"?`)) return;
            
            try {
                await fetch(`/api/forms/${id}`, { method: 'DELETE' });
                loadForms();
            } catch (error) {
                console.error('Error deleting form:', error);
                alert('Error deleting form');
            }
        }

        // Form submission
        document.getElementById('custody-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            const multiselectFields = new Set();
            
            // Collect multiselect fields
            if (formMetadata && formMetadata.tabs[currentTab]) {
                formMetadata.tabs[currentTab].sections.forEach(section => {
                    section.fields.forEach(field => {
                        if (field.type === 'multiselect' || field.type === 'checkbox-group') {
                            multiselectFields.add(field.name);
                        }
                    });
                });
            }
            
            // Process form data
            for (let [key, value] of formData.entries()) {
                const field = this[key];
                
                if (multiselectFields.has(key)) {
                    if (!data[key]) data[key] = [];
                    data[key].push(value);
                } else if (field && field.type === 'checkbox') {
                    data[key] = field.checked;
                } else {
                    data[key] = value;
                }
            }
            
            // Handle unchecked checkboxes
            multiselectFields.forEach(fieldName => {
                if (!data[fieldName]) {
                    data[fieldName] = [];
                }
            });

            const payload = {
                clientName: data.newAccountNameLegal || data.clientName || 'Unnamed Client',
                status: 'draft',
                formData: {
                    [`tab${currentTab}`]: data
                }
            };

            try {
                const response = await fetch('/api/forms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save form');
                }
                
                alert('Form saved successfully!');
                showFormsListPage();
            } catch (error) {
                console.error('Error saving form:', error);
                alert('Error saving form: ' + error.message);
            }
        });

        // Chatbot functionality
        let chatbotOpen = false;
        let currentLanguage = 'en'; // Default to English
        
        // Language detection function
        function detectLanguage(text) {
            // Simple language detection based on character patterns
            const chinesePattern = /[\u4e00-\u9fff]/;
            const japanesePattern = /[\u3040-\u309f\u30a0-\u30ff]/;
            const spanishPattern = /[ñáéíóúüç]/i;
            
            if (chinesePattern.test(text)) {
                return 'zh';
            } else if (japanesePattern.test(text)) {
                return 'ja';
            } else if (spanishPattern.test(text)) {
                return 'es';
            }
            return 'en';
        }
        
        // Multilingual translations
        const translations = {
            en: {
                welcome: "Hi! I'm here to help you with questions about the XYZ Custody Account Opening Form. How can I assist you today?",
                accountNaming: `<strong>Account Naming Guidelines:</strong><br><br>
                        • <strong>Legal Title:</strong> Use full legal name, up to 228 characters<br>
                        • <strong>Short Name:</strong> 30 character limit for XYZ Infuse and wire transfers<br>
                        • Must be unique and recognizable<br><br>
                        <em>Different entity types have specific naming conventions - check Section 1 of the User Guide for details!</em>`,
                swift: `<strong>SWIFT/BIC Codes:</strong><br><br>
                        • Use 8 or 11 character SWIFT/BIC codes<br>
                        • Required for wire transfers and trade confirmations<br>
                        • Must be valid and active codes<br>
                        • Contact name will be populated with your account Short Title<br><br>
                        <em>Need help with specific SWIFT messages? Check Section 12 in the User Guide!</em>`,
                tax: `<strong>Tax Treatment Guidelines:</strong><br><br>
                        • Enter your tax classification from IRS Form W-8/W-9<br>
                        • For U.S. accounts: enter actual state, not just "U.S."<br>
                        • U.S. citizens abroad: enter "United States" as domicile<br>
                        • FATCA withholding may apply without proper documentation<br><br>
                        <em>See Section 4 in the User Guide for complete tax guidance!</em>`,
                services: `<strong>Account Services:</strong><br><br>
                        • <strong>Cash Services:</strong> Required for cash-only accounts<br>
                        • <strong>Custody Services:</strong> For securities safekeeping & administration<br>
                        • <strong>Foreign Exchange:</strong> Enables FX trading capabilities<br>
                        • Account type determined by your service selections<br><br>
                        <em>Services must match what's contracted with XYZ - see Section 2!</em>`,
                markets: `<strong>Markets & Currencies:</strong><br><br>
                        • Select only required markets and currencies<br>
                        • Missing markets may delay account opening<br>
                        • Some markets need more than 1 business day to open<br>
                        • Euroclear/Clearstream for international fixed income<br><br>
                        <em>Check Section 3 for detailed market selection guidance!</em>`,
                help: `<strong>Getting Help:</strong><br><br>
                        • Look for 💡 help text below each field<br>
                        • Check the User Guide tab for detailed guidance<br>
                        • Contact your Client Service Representative<br>
                        • Review XYZ Infuse documentation<br><br>
                        <em>I can also answer specific questions about form sections!</em>`,
                wire: `<strong>Wire Transfer Setup:</strong><br><br>
                        • Provide complete address for electronic transfers<br>
                        • Contact name uses your account Short Title<br>
                        • No PO Box or "Personal/Confidential" in address<br>
                        • Can use same address as tax documentation<br><br>
                        <em>See Section 8 for wire transfer address requirements!</em>`,
                default: [
                    `I can help you with questions about:<br><br>
                     • Account naming and setup<br>
                     • SWIFT codes and wire transfers<br>
                     • Tax treatment and FATCA<br>
                     • Services and market selection<br>
                     • Form navigation and requirements<br><br>
                     <em>Try asking about any of these topics!</em>`,
                    `For detailed guidance, check the <strong>User Guide tab</strong> which covers all 15 sections of the form. You can also look at the 💡 help text below each field for specific requirements.`,
                    `I'm designed to help with the XYZ Custody Account Opening Form. Try asking about specific sections like "account naming", "tax treatment", or "SWIFT codes" for detailed guidance!`
                ]
            },
            es: {
                welcome: "¡Hola! Estoy aquí para ayudarte con preguntas sobre el Formulario de Apertura de Cuenta de Custodia XYZ. ¿Cómo puedo asistirte hoy?",
                accountNaming: `<strong>Directrices para Nombres de Cuenta:</strong><br><br>
                        • <strong>Título Legal:</strong> Use el nombre legal completo, hasta 228 caracteres<br>
                        • <strong>Nombre Corto:</strong> Límite de 30 caracteres para XYZ Infuse y transferencias<br>
                        • Debe ser único y reconocible<br><br>
                        <em>Diferentes tipos de entidades tienen convenciones específicas - ¡consulte la Sección 1 de la Guía del Usuario!</em>`,
                swift: `<strong>Códigos SWIFT/BIC:</strong><br><br>
                        • Use códigos SWIFT/BIC de 8 u 11 caracteres<br>
                        • Requeridos para transferencias y confirmaciones comerciales<br>
                        • Deben ser códigos válidos y activos<br>
                        • El nombre de contacto se poblará con su Título Corto de cuenta<br><br>
                        <em>¿Necesita ayuda con mensajes SWIFT específicos? ¡Consulte la Sección 12!</em>`,
                tax: `<strong>Directrices de Tratamiento Fiscal:</strong><br><br>
                        • Ingrese su clasificación fiscal del Formulario IRS W-8/W-9<br>
                        • Para cuentas de EE.UU.: ingrese el estado real, no solo "EE.UU."<br>
                        • Ciudadanos de EE.UU. en el extranjero: ingrese "Estados Unidos" como domicilio<br>
                        • La retención FATCA puede aplicar sin documentación adecuada<br><br>
                        <em>¡Vea la Sección 4 para orientación fiscal completa!</em>`,
                services: `<strong>Servicios de Cuenta:</strong><br><br>
                        • <strong>Servicios de Efectivo:</strong> Requeridos para cuentas solo de efectivo<br>
                        • <strong>Servicios de Custodia:</strong> Para custodia y administración de valores<br>
                        • <strong>Cambio de Divisas:</strong> Habilita capacidades comerciales FX<br>
                        • Tipo de cuenta determinado por sus selecciones de servicios<br><br>
                        <em>¡Los servicios deben coincidir con lo contratado con XYZ!</em>`,
                markets: `<strong>Mercados y Monedas:</strong><br><br>
                        • Seleccione solo mercados y monedas requeridos<br>
                        • Mercados faltantes pueden retrasar la apertura<br>
                        • Algunos mercados necesitan más de 1 día hábil para abrir<br>
                        • Euroclear/Clearstream para renta fija internacional<br><br>
                        <em>¡Consulte la Sección 3 para orientación detallada!</em>`,
                help: `<strong>Obteniendo Ayuda:</strong><br><br>
                        • Busque el texto de ayuda 💡 debajo de cada campo<br>
                        • Consulte la pestaña Guía del Usuario<br>
                        • Contacte a su Representante de Servicio al Cliente<br>
                        • Revise la documentación de XYZ Infuse<br><br>
                        <em>¡También puedo responder preguntas específicas sobre secciones!</em>`,
                wire: `<strong>Configuración de Transferencia:</strong><br><br>
                        • Proporcione dirección completa para transferencias electrónicas<br>
                        • El nombre de contacto usa su Título Corto de cuenta<br>
                        • No use apartado postal o "Personal/Confidencial"<br>
                        • Puede usar la misma dirección que documentación fiscal<br><br>
                        <em>¡Vea la Sección 8 para requisitos de dirección!</em>`,
                default: [
                    `Puedo ayudarte con preguntas sobre:<br><br>
                     • Nomenclatura y configuración de cuentas<br>
                     • Códigos SWIFT y transferencias<br>
                     • Tratamiento fiscal y FATCA<br>
                     • Selección de servicios y mercados<br>
                     • Navegación y requisitos del formulario<br><br>
                     <em>¡Pregunta sobre cualquiera de estos temas!</em>`,
                    `Para orientación detallada, consulte la <strong>pestaña Guía del Usuario</strong> que cubre las 15 secciones del formulario.`,
                    `Estoy diseñado para ayudar con el Formulario XYZ. ¡Pregunta sobre secciones específicas como "nombres de cuenta", "tratamiento fiscal" o "códigos SWIFT"!`
                ]
            },
            zh: {
                welcome: "您好！我在这里帮助您解答关于XYZ托管账户开户表格的问题。今天我能为您提供什么帮助？",
                accountNaming: `<strong>账户命名指南：</strong><br><br>
                        • <strong>法定名称：</strong> 使用完整法定名称，最多228个字符<br>
                        • <strong>简称：</strong> XYZ Infuse和电汇限制30个字符<br>
                        • 必须唯一且可识别<br><br>
                        <em>不同实体类型有特定命名约定 - 请查看用户指南第1部分！</em>`,
                swift: `<strong>SWIFT/BIC代码：</strong><br><br>
                        • 使用8或11位SWIFT/BIC代码<br>
                        • 电汇和交易确认需要<br>
                        • 必须是有效和活跃的代码<br>
                        • 联系人姓名将使用您的账户简称<br><br>
                        <em>需要特定SWIFT消息帮助？查看第12部分！</em>`,
                tax: `<strong>税务处理指南：</strong><br><br>
                        • 输入IRS表格W-8/W-9的税务分类<br>
                        • 美国账户：输入实际州份，不只是"美国"<br>
                        • 海外美国公民：输入"美国"作为税务居住地<br>
                        • 没有适当文件可能适用FATCA预扣税<br><br>
                        <em>查看第4部分获取完整税务指导！</em>`,
                services: `<strong>账户服务：</strong><br><br>
                        • <strong>现金服务：</strong> 纯现金账户必需<br>
                        • <strong>托管服务：</strong> 用于证券保管和管理<br>
                        • <strong>外汇：</strong> 启用外汇交易功能<br>
                        • 账户类型由服务选择决定<br><br>
                        <em>服务必须与XYZ合约匹配 - 查看第2部分！</em>`,
                markets: `<strong>市场和货币：</strong><br><br>
                        • 仅选择所需的市场和货币<br>
                        • 缺失市场可能延迟开户<br>
                        • 某些市场需要超过1个工作日开通<br>
                        • Euroclear/Clearstream用于国际固收<br><br>
                        <em>查看第3部分获取详细选择指导！</em>`,
                help: `<strong>获取帮助：</strong><br><br>
                        • 查看每个字段下方的💡帮助文本<br>
                        • 查看用户指南选项卡获取详细指导<br>
                        • 联系您的客户服务代表<br>
                        • 查看XYZ Infuse文档<br><br>
                        <em>我也可以回答关于表格部分的具体问题！</em>`,
                wire: `<strong>电汇设置：</strong><br><br>
                        • 提供完整地址用于电子转账<br>
                        • 联系人姓名使用您的账户简称<br>
                        • 地址中不要包含邮政信箱或"个人/机密"<br>
                        • 可以使用与税务文件相同的地址<br><br>
                        <em>查看第8部分了解电汇地址要求！</em>`,
                default: [
                    `我可以帮助您解答关于以下问题：<br><br>
                     • 账户命名和设置<br>
                     • SWIFT代码和电汇<br>
                     • 税务处理和FATCA<br>
                     • 服务和市场选择<br>
                     • 表格导航和要求<br><br>
                     <em>请询问这些主题中的任何一个！</em>`,
                    `如需详细指导，请查看<strong>用户指南选项卡</strong>，其中包含表格的所有15个部分。`,
                    `我专门帮助处理XYZ托管账户开户表格。请询问具体部分，如"账户命名"、"税务处理"或"SWIFT代码"！`
                ]
            },
            ja: {
                welcome: "こんにちは！XYZカストディ口座開設フォームに関するご質問をお手伝いします。今日はどのようなご用件でしょうか？",
                accountNaming: `<strong>口座名義ガイドライン：</strong><br><br>
                        • <strong>正式名称：</strong> 完全な法的名称を使用、最大228文字<br>
                        • <strong>略称：</strong> XYZ Infuseと電信送金用30文字制限<br>
                        • 固有で認識可能である必要があります<br><br>
                        <em>異なる事業体タイプには特定の命名規則があります - ユーザーガイドセクション1をご確認ください！</em>`,
                swift: `<strong>SWIFT/BICコード：</strong><br><br>
                        • 8桁または11桁のSWIFT/BICコードを使用<br>
                        • 電信送金と取引確認に必要<br>
                        • 有効でアクティブなコードである必要があります<br>
                        • 連絡先名は口座略称で入力されます<br><br>
                        <em>特定のSWIFTメッセージのヘルプが必要ですか？セクション12をご確認ください！</em>`,
                tax: `<strong>税務処理ガイドライン：</strong><br><br>
                        • IRSフォームW-8/W-9から税務分類を入力<br>
                        • 米国口座の場合：「米国」ではなく実際の州を入力<br>
                        • 海外在住米国市民：居住地として「米国」を入力<br>
                        • 適切な書類がない場合、FATCA源泉徴収が適用される可能性があります<br><br>
                        <em>完全な税務ガイダンスについてはセクション4をご覧ください！</em>`,
                services: `<strong>口座サービス：</strong><br><br>
                        • <strong>現金サービス：</strong> 現金のみ口座に必要<br>
                        • <strong>カストディサービス：</strong> 証券の保管と管理用<br>
                        • <strong>外国為替：</strong> FX取引機能を有効化<br>
                        • 口座タイプはサービス選択によって決定されます<br><br>
                        <em>サービスはXYZとの契約内容と一致する必要があります - セクション2をご覧ください！</em>`,
                markets: `<strong>市場と通貨：</strong><br><br>
                        • 必要な市場と通貨のみを選択<br>
                        • 不足している市場は口座開設を遅らせる可能性があります<br>
                        • 一部の市場は開設に1営業日以上必要<br>
                        • 国際債券にはEuroclear/Clearstream<br><br>
                        <em>詳細な選択ガイダンスについてはセクション3をご確認ください！</em>`,
                help: `<strong>ヘルプの取得：</strong><br><br>
                        • 各フィールド下の💡ヘルプテキストを確認<br>
                        • 詳細なガイダンスについてはユーザーガイドタブを確認<br>
                        • クライアントサービス担当者にお問い合わせください<br>
                        • XYZ Infuseドキュメントを確認<br><br>
                        <em>フォームセクションに関する具体的な質問にもお答えできます！</em>`,
                wire: `<strong>電信送金設定：</strong><br><br>
                        • 電子送金用の完全な住所を提供<br>
                        • 連絡先名は口座略称を使用<br>
                        • 私書箱や「Personal/Confidential」は住所に含めない<br>
                        • 税務書類と同じ住所を使用可能<br><br>
                        <em>電信送金住所要件についてはセクション8をご覧ください！</em>`,
                default: [
                    `以下について質問をお手伝いできます：<br><br>
                     • 口座命名と設定<br>
                     • SWIFTコードと電信送金<br>
                     • 税務処理とFATCA<br>
                     • サービスと市場選択<br>
                     • フォームナビゲーションと要件<br><br>
                     <em>これらのトピックについてお気軽にお尋ねください！</em>`,
                    `詳細なガイダンスについては、フォームの全15セクションをカバーする<strong>ユーザーガイドタブ</strong>をご確認ください。`,
                    `XYZカストディ口座開設フォームのお手伝いをするよう設計されています。「口座命名」、「税務処理」、「SWIFTコード」などの具体的なセクションについてお尋ねください！`
                ]
            }
        };
        
        function toggleChatbot() {
            const panel = document.getElementById('chatbot-panel');
            const icon = document.getElementById('chatbot-icon');
            
            chatbotOpen = !chatbotOpen;
            
            if (chatbotOpen) {
                panel.classList.add('open');
                icon.textContent = '✖️';
                
                // Initialize chatbot with default language
                initializeChatbot();
            } else {
                panel.classList.remove('open');
                icon.textContent = '💬';
            }
        }
        
        function initializeChatbot() {
            // Detect browser language preference
            const browserLang = navigator.language.substring(0, 2);
            if (['en', 'es', 'zh', 'ja'].includes(browserLang)) {
                currentLanguage = browserLang;
            }
            
            // Update welcome message
            const welcomeMessage = document.getElementById('welcome-message');
            welcomeMessage.innerHTML = translations[currentLanguage].welcome;
            
            // Update suggestion chips
            updateSuggestions();
            
            // Update input placeholder
            const placeholders = {
                en: 'Ask me anything about the form...',
                es: 'Pregúntame sobre el formulario...',
                zh: '询问关于表格的任何问题...',
                ja: 'フォームについて何でもお聞きください...'
            };
            
            const input = document.getElementById('chatbot-input');
            input.placeholder = placeholders[currentLanguage];
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function sendSuggestion(message) {
            document.getElementById('chatbot-input').value = message;
            sendMessage();
        }
        
        function sendMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Simulate bot response delay
            setTimeout(() => {
                hideTypingIndicator();
                const response = getBotResponse(message);
                addMessage(response, 'bot');
                
                // Update suggestion chips based on detected language
                updateSuggestions();
            }, 1500);
        }
        
        function updateSuggestions() {
            const suggestionsContainer = document.getElementById('chatbot-suggestions');
            const suggestions = {
                en: [
                    { text: 'Account naming help', query: 'How do I fill account name?' },
                    { text: 'SWIFT codes', query: 'What are SWIFT codes?' },
                    { text: 'Tax help', query: 'Tax treatment guide' }
                ],
                es: [
                    { text: 'Ayuda nombres cuenta', query: '¿Cómo lleno el nombre de cuenta?' },
                    { text: 'Códigos SWIFT', query: '¿Qué son los códigos SWIFT?' },
                    { text: 'Ayuda fiscal', query: 'Guía tratamiento fiscal' }
                ],
                zh: [
                    { text: '账户命名帮助', query: '如何填写账户名称？' },
                    { text: 'SWIFT代码', query: '什么是SWIFT代码？' },
                    { text: '税务帮助', query: '税务处理指南' }
                ],
                ja: [
                    { text: '口座名義ヘルプ', query: '口座名はどう記入しますか？' },
                    { text: 'SWIFTコード', query: 'SWIFTコードとは？' },
                    { text: '税務ヘルプ', query: '税務処理ガイド' }
                ]
            };
            
            const currentSuggestions = suggestions[currentLanguage];
            suggestionsContainer.innerHTML = currentSuggestions.map(suggestion => 
                `<div class="suggestion-chip" onclick="sendSuggestion('${suggestion.query}')">${suggestion.text}</div>`
            ).join('');
        }
        
        function addMessage(message, sender) {
            const messagesContainer = document.getElementById('chatbot-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${sender}`;
            avatarDiv.textContent = sender === 'bot' ? '🤖' : '👤';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `message-content ${sender}`;
            contentDiv.innerHTML = message;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function showTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'flex';
            const messagesContainer = document.getElementById('chatbot-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function hideTypingIndicator() {
            document.getElementById('typing-indicator').style.display = 'none';
        }
        
        // Language detection function
        function detectLanguage(text) {
            const chinesePattern = /[\u4e00-\u9fff]/;
            const japanesePattern = /[\u3040-\u309f\u30a0-\u30ff]/;
            const spanishPattern = /[ñáéíóúüç]|que|los|las|son|servicios|ofrecen|cuales/i;
            
            if (chinesePattern.test(text)) {
                return 'zh';
            }
            if (japanesePattern.test(text)) {
                return 'ja';
            }
            if (spanishPattern.test(text)) {
                return 'es';
            }
            return 'en'; // default to English
        }

        function getBotResponse(message) {
            // Detect language from user message
            const detectedLang = detectLanguage(message);
            currentLanguage = detectedLang;
            
            const lowercaseMessage = message.toLowerCase();
            const t = translations[currentLanguage];
            
            // Define keyword patterns for different languages
            const keywords = {
                accountName: {
                    en: ['account name', 'naming', 'legal title', 'short name'],
                    es: ['nombre cuenta', 'nomenclatura', 'título legal', 'nombre corto'],
                    zh: ['账户名', '命名', '账户名称', '法定名称', '简称'],
                    ja: ['口座名', '名義', '正式名称', '略称']
                },
                swift: {
                    en: ['swift', 'bic', 'wire transfer', 'bank code'],
                    es: ['swift', 'bic', 'transferencia', 'código banco'],
                    zh: ['swift', 'bic', '电汇', '银行代码'],
                    ja: ['swift', 'bic', '電信送金', '銀行コード']
                },
                tax: {
                    en: ['tax', 'fatca', 'withhold', 'classification'],
                    es: ['impuesto', 'fiscal', 'fatca', 'retención'],
                    zh: ['税', '税务', 'fatca', '预扣', '分类'],
                    ja: ['税', '税務', 'fatca', '源泉徴収', '分類']
                },
                services: {
                    en: ['service', 'services', 'custody', 'cash', 'foreign exchange'],
                    es: ['servicio', 'servicios', 'custodia', 'efectivo', 'divisas'],
                    zh: ['服务', '托管', '现金', '外汇'],
                    ja: ['サービス', 'カストディ', '現金', '外国為替']
                },
                markets: {
                    en: ['market', 'currency', 'global', 'euroclear'],
                    es: ['mercado', 'moneda', 'global', 'euroclear'],
                    zh: ['市场', '货币', '全球', '欧洲清算'],
                    ja: ['市場', '通貨', 'グローバル', 'ユーロクリア']
                },
                help: {
                    en: ['help', 'support', 'contact', 'assistance'],
                    es: ['ayuda', 'soporte', 'contacto', 'asistencia'],
                    zh: ['帮助', '支持', '联系', '协助'],
                    ja: ['ヘルプ', 'サポート', '連絡', '支援']
                },
                wire: {
                    en: ['wire', 'transfer', 'address', 'electronic'],
                    es: ['transferencia', 'dirección', 'electrónica'],
                    zh: ['电汇', '转账', '地址', '电子'],
                    ja: ['電信送金', '送金', '住所', '電子']
                }
            };
            
            // Check for matches in the detected language
            const checkKeywords = (category) => {
                const categoryKeywords = keywords[category][currentLanguage] || keywords[category]['en'];
                return categoryKeywords.some(keyword => lowercaseMessage.includes(keyword));
            };
            
            // Return appropriate response based on detected keywords
            if (checkKeywords('accountName')) {
                return t.accountNaming;
            }
            
            if (checkKeywords('swift')) {
                return t.swift;
            }
            
            if (checkKeywords('tax')) {
                return t.tax;
            }
            
            if (checkKeywords('services')) {
                return t.services;
            }
            
            if (checkKeywords('markets')) {
                return t.markets;
            }
            
            if (checkKeywords('help')) {
                return t.help;
            }
            
            if (checkKeywords('wire')) {
                return t.wire;
            }
            
            // Return random default response in detected language
            return t.default[Math.floor(Math.random() * t.default.length)];
        }

        // Workflow Integration
        let currentWorkflowId = null;
        let workflowData = null;

        // Check if we're coming from the workflow dashboard
        function checkWorkflowContext() {
            currentWorkflowId = sessionStorage.getItem('currentWorkflowId');
            const workflowDataStr = sessionStorage.getItem('workflowData');
            
            if (currentWorkflowId && workflowDataStr) {
                workflowData = JSON.parse(workflowDataStr);
                console.log('Loading form from workflow:', workflowData.title);
                return true;
            }
            return false;
        }

        // Add Back to Dashboard button for workflow context
        function addBackToDashboardButton() {
            // Try multiple selectors to find the header
            let header = document.querySelector('.main-header .header-content');
            if (!header) {
                header = document.querySelector('.main-header');
            }
            if (!header) {
                header = document.querySelector('header');
            }
            if (!header) {
                // Create a fixed position button if no header found
                console.log('No header found, creating fixed position back button');
                createFixedBackButton();
                return;
            }
            
            if (header && !document.getElementById('back-to-dashboard')) {
                const backButton = document.createElement('button');
                backButton.id = 'back-to-dashboard';
                backButton.className = 'back-button';
                backButton.innerHTML = '← Back to Dashboard';
                backButton.style.cssText = `
                    position: absolute;
                    left: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: #667eea;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: 500;
                `;
                backButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Back to Dashboard button clicked');
                    
                    // Clear workflow context and go back to dashboard
                    sessionStorage.removeItem('currentWorkflowId');
                    sessionStorage.removeItem('workflowData');
                    
                    console.log('Redirecting to workflow dashboard...');
                    window.location.href = '/workflow-dashboard.html';
                });
                header.appendChild(backButton);
            }
        }

        // Create fixed position back button as fallback
        function createFixedBackButton() {
            if (document.getElementById('back-to-dashboard')) return;
            
            const backButton = document.createElement('button');
            backButton.id = 'back-to-dashboard';
            backButton.className = 'back-button fixed';
            backButton.innerHTML = '← Back to Dashboard';
            backButton.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: #667eea;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 14px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transition: all 0.3s ease;
            `;
            
            backButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Fixed Back to Dashboard button clicked');
                
                // Clear workflow context and go back to dashboard
                sessionStorage.removeItem('currentWorkflowId');
                sessionStorage.removeItem('workflowData');
                
                console.log('Redirecting to workflow dashboard...');
                window.location.href = '/workflow-dashboard.html';
            });
            
            // Add hover effect
            backButton.addEventListener('mouseenter', function() {
                this.style.background = '#5a6fd8';
                this.style.transform = 'translateY(-2px)';
            });
            
            backButton.addEventListener('mouseleave', function() {
                this.style.background = '#667eea';
                this.style.transform = 'translateY(0)';
            });
            
            document.body.appendChild(backButton);
            console.log('Fixed position back button created');
        }

        // Add Submit for Review button for workflow context
        function addSubmitButton() {
            if (!currentWorkflowId || workflowData.status !== 'draft') return;
            
            const header = document.querySelector('.main-header .header-content');
            if (header && !document.getElementById('submit-for-review')) {
                const submitButton = document.createElement('button');
                submitButton.id = 'submit-for-review';
                submitButton.className = 'submit-button';
                submitButton.innerHTML = '✓ Submit for Review';
                submitButton.style.cssText = `
                    position: absolute;
                    right: 20px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: #27ae60;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-weight: 500;
                `;
                submitButton.addEventListener('click', submitFormForReview);
                header.appendChild(submitButton);
            }
        }

        // Submit form for review
        async function submitFormForReview() {
            if (!currentWorkflowId) return;
            
            // Save current form data first
            await saveFormToWorkflow();
            
            // Ask for confirmation
            if (!confirm('Are you sure you want to submit this form for review? You won\'t be able to edit it after submission.')) {
                return;
            }
            
            try {
                // Submit workflow
                await apiCall(`/workflows/${currentWorkflowId}/submit`, {
                    method: 'POST',
                    body: JSON.stringify({
                        comment: 'Form completed and submitted for review.'
                    })
                });
                
                showMessage('Form submitted for review successfully!', 'success');
                
                // Redirect back to dashboard after a delay
                setTimeout(() => {
                    sessionStorage.removeItem('currentWorkflowId');
                    sessionStorage.removeItem('workflowData');
                    window.location.href = '/workflow-dashboard.html';
                }, 2000);
                
            } catch (error) {
                showMessage('Error submitting form: ' + error.message, 'error');
            }
        }

        // API helper for workflow operations
        async function apiCall(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            };
            
            const response = await fetch(`/api${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Request failed');
            }
            
            return response.json();
        }

        // Save form data to workflow
        async function saveFormToWorkflow() {
            if (!currentWorkflowId) return;
            
            try {
                // Get current form data
                const formData = getCurrentFormData();
                
                // Update workflow with form data
                await apiCall(`/workflows/${currentWorkflowId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        title: workflowData.title,
                        description: workflowData.description,
                        priority: workflowData.priority,
                        metadata: {
                            ...workflowData.metadata,
                            formData: formData,
                            lastSaved: new Date().toISOString()
                        }
                    })
                });
                
                console.log('Form data saved to workflow');
                showSaveSuccess();
            } catch (error) {
                console.error('Error saving form to workflow:', error);
                showSaveError(error.message);
            }
        }

        // Get current form data from all form pages
        function getCurrentFormData() {
            const formData = {};
            
            // Get data from all form inputs
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.id && input.value) {
                    formData[input.id] = input.value;
                }
            });
            
            return formData;
        }

        // Load form data from workflow
        function loadFormDataFromWorkflow() {
            if (!workflowData || !workflowData.metadata || !workflowData.metadata.formData) {
                return;
            }
            
            const formData = workflowData.metadata.formData;
            
            // Populate form fields with saved data
            Object.keys(formData).forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.value = formData[fieldId];
                }
            });
            
            console.log('Form data loaded from workflow');
        }

        // Auto-save functionality
        function setupAutoSave() {
            if (!currentWorkflowId) return;
            
            // Auto-save every 30 seconds
            setInterval(saveFormToWorkflow, 30000);
            
            // Save on form field changes (debounced)
            let saveTimeout;
            document.addEventListener('input', function(e) {
                if (e.target.matches('input, select, textarea')) {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(saveFormToWorkflow, 3000);
                }
            });
        }

        // Show save success message
        function showSaveSuccess() {
            showMessage('Form saved successfully', 'success');
        }

        // Show save error message
        function showSaveError(error) {
            showMessage('Error saving form: ' + error, 'error');
        }

        // Show message to user
        function showMessage(message, type) {
            // Remove existing message
            const existingMessage = document.getElementById('save-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.id = 'save-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
            `;
            
            document.body.appendChild(messageDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        // Update form title for workflow context
        function updateFormTitle() {
            if (workflowData && workflowData.title) {
                const titleElement = document.querySelector('.main-header h1');
                if (titleElement) {
                    titleElement.textContent = workflowData.title;
                }
            }
        }

        // Add back to dashboard button
        function addBackToDashboardButton() {
            // Check if button already exists
            if (document.getElementById('back-to-dashboard-btn')) {
                return;
            }
            
            const backButton = document.createElement('button');
            backButton.id = 'back-to-dashboard-btn';
            backButton.textContent = '← Back to Dashboard';
            backButton.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 12px 20px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
            `;
            
            // Add hover effect
            backButton.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            });
            
            backButton.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
            });
            
            backButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Save form before leaving
                if (currentWorkflowId) {
                    saveFormToWorkflow();
                }
                
                // Redirect to workflow dashboard
                window.location.href = '/workflow-dashboard.html';
            });
            
            document.body.appendChild(backButton);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initialized');
            
            // Check if we're in workflow context
            if (checkWorkflowContext()) {
                // We're coming from workflow dashboard
                addBackToDashboardButton();
                addSubmitButton();
                updateFormTitle();
                
                // Form will show by default when no forms list is displayed
                // Hide forms list if it exists
                const formsList = document.getElementById('forms-list');
                if (formsList) {
                    formsList.style.display = 'none';
                }
                
                // Load form data after a short delay to ensure form is rendered
                setTimeout(() => {
                    loadFormDataFromWorkflow();
                    setupAutoSave();
                }, 500);
            } else {
                // Normal form access - form should be visible by default
                console.log('Normal form access - comprehensive form should be visible');
                
                // Load form metadata for the comprehensive form
                if (!formMetadata) {
                    loadFormMetadata();
                } else {
                    renderFormContent();
                }
            }
        });
    </script>

    <!-- Chatbot Widget -->
    <div class="chatbot-widget">
        <div class="chatbot-panel" id="chatbot-panel">
            <div class="chatbot-header">
                <div class="chatbot-avatar">🤖</div>
                <div class="chatbot-info">
                    <h3>XYZ Guide Assistant</h3>
                    <p>Ask me about the form guide</p>
                </div>
            </div>
            
            <div class="chatbot-messages" id="chatbot-messages">
                <div class="chat-message">
                    <div class="message-avatar bot">🤖</div>
                    <div class="message-content bot" id="welcome-message">
                        Hi! I'm here to help you with questions about the XYZ Custody Account Opening Form. How can I assist you today?
                    </div>
                </div>
                
                <div class="typing-indicator" id="typing-indicator">
                    <div class="message-avatar bot">🤖</div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
            
            <div class="chatbot-input-area">
                <div class="chatbot-suggestions" id="chatbot-suggestions">
                    <div class="suggestion-chip" onclick="sendSuggestion('How do I fill account name?')">Account naming help</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('What are SWIFT codes?')">SWIFT codes</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Tax treatment guide')">Tax help</div>
                </div>
                
                <div class="chatbot-input">
                    <input type="text" id="chatbot-input" placeholder="Ask me anything about the form..." 
                           onkeypress="handleChatKeyPress(event)">
                    <button class="chatbot-send" onclick="sendMessage()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <button class="chatbot-toggle" onclick="toggleChatbot()">
            <span id="chatbot-icon">💬</span>
        </button>
    </div>
</body>
</html>